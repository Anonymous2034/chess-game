<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#312e2b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Play chess against AI bots, solve puzzles, and analyze games">
  <!-- Open Graph — professional link previews when sharing -->
  <meta property="og:title" content="Grandmasters Chess">
  <meta property="og:description" content="Play chess against AI grandmasters, solve puzzles, and analyze games">
  <meta property="og:image" content="icons/icon-512.png">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Grandmasters Chess">
  <meta name="twitter:description" content="Play chess against AI grandmasters, solve puzzles, and analyze games">
  <meta name="twitter:image" content="icons/icon-512.png">
  <title>Grandmasters</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="icons/icon-192.png" type="image/png" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="stylesheet" href="css/style.css?v=160">
  <script type="importmap">
  {
    "imports": {
      "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
    }
  }
  </script>
</head>
<body>
  <!-- Password gate — blocks casual access -->
  <div id="password-gate" style="display:none;position:fixed;inset:0;z-index:99999;background:#1a1a1a;align-items:center;justify-content:center;flex-direction:column;font-family:system-ui,sans-serif">
    <div style="text-align:center;color:#e0d6c2;max-width:340px;padding:24px">
      <div style="font-size:48px;margin-bottom:12px">♚</div>
      <h1 style="font-size:22px;margin:0 0 6px;color:#f0e8d8">Grandmasters Chess</h1>
      <p style="font-size:13px;color:#888;margin:0 0 20px">Private access — enter password to continue</p>
      <input id="gate-input" type="password" placeholder="Password" autocomplete="off"
        style="width:100%;padding:10px 14px;font-size:16px;border:1px solid #444;border-radius:6px;background:#2a2a2a;color:#f0e8d8;outline:none;box-sizing:border-box;text-align:center">
      <button id="gate-btn"
        style="width:100%;margin-top:10px;padding:10px;font-size:15px;font-weight:600;border:none;border-radius:6px;background:#7b6f3e;color:#f0e8d8;cursor:pointer">Enter</button>
      <p id="gate-error" style="color:#c44;font-size:13px;margin:8px 0 0;display:none">Incorrect password</p>
    </div>
  </div>
  <script>
  (function(){
    const HASH = '2b4f742576fe2c08fab3561b5721497e995b79c444f39f23b987c37b3d10e6d6';
    const KEY = 'chess_gate_pass';
    const gate = document.getElementById('password-gate');
    async function sha256(str) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
    }
    async function check(val) {
      return (await sha256(val)) === HASH;
    }
    async function tryUnlock(val) {
      if (await check(val)) {
        sessionStorage.setItem(KEY, val);
        gate.style.display = 'none';
      } else {
        document.getElementById('gate-error').style.display = '';
        document.getElementById('gate-input').value = '';
        document.getElementById('gate-input').focus();
      }
    }
    // Auto-unlock if already authenticated this session, or on localhost
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname.endsWith('github.io')) { gate.style.display = 'none'; }
    else {
    const saved = sessionStorage.getItem(KEY);
    if (saved) { check(saved).then(ok => { if (ok) gate.style.display = 'none'; else gate.style.display = 'flex'; }); }
    else { gate.style.display = 'flex'; }
    }
    document.getElementById('gate-btn').addEventListener('click', () => tryUnlock(document.getElementById('gate-input').value));
    document.getElementById('gate-input').addEventListener('keydown', e => { if (e.key === 'Enter') tryUnlock(e.target.value); });
  })();
  </script>

  <div class="offline-indicator" id="offline-indicator">You are offline — some features are unavailable</div>

  <!-- PWA Install Banner -->
  <div class="pwa-install-banner hidden" id="pwa-install-banner">
    <span class="pwa-install-text">Install Grandmasters Chess for the best experience</span>
    <button class="btn btn-sm btn-primary" id="pwa-install-btn">Install</button>
    <button class="btn btn-sm pwa-install-dismiss" id="pwa-install-dismiss">&times;</button>
  </div>

  <div id="app">
    <!-- Bot Builder Dialog -->
    <div id="bot-builder-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-bot-builder">
        <h2 id="bot-builder-title">Create Custom Bot</h2>
        <div class="bot-builder-body">
          <div class="bot-builder-left">
            <div class="bb-field">
              <label>Name</label>
              <input type="text" id="bb-name" maxlength="24" placeholder="Bot name">
            </div>
            <div class="bb-field">
              <label>Subtitle</label>
              <input type="text" id="bb-subtitle" maxlength="40" placeholder="Short description">
            </div>
            <div class="bb-field">
              <label>Avatar</label>
              <div class="bb-avatar-grid" id="bb-avatar-grid"></div>
            </div>
            <div class="bb-field">
              <label>Rating: <span id="bb-rating-val">1200</span></label>
              <input type="range" id="bb-rating" min="400" max="3000" value="1200" step="50" class="bb-slider">
              <div class="bb-range-labels"><span>400</span><span>3000</span></div>
            </div>
            <div class="bb-field">
              <label>Style Profile</label>
              <div class="bb-styles" id="bb-styles"></div>
            </div>
          </div>
          <div class="bot-builder-right">
            <label>Preview</label>
            <div class="bb-preview-card" id="bb-preview-card"></div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-danger hidden" id="bb-delete">Delete</button>
          <span style="flex:1"></span>
          <button class="btn btn-secondary" id="bb-cancel">Cancel</button>
          <button class="btn btn-primary" id="bb-save">Save Bot</button>
        </div>
      </div>
    </div>

    <!-- New Game Dialog -->
    <div id="new-game-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-new-game">
        <h2>New Game</h2>
        <div class="new-game-top-row">
          <div class="new-game-top-item">
            <label>Mode</label>
            <div class="btn-group" data-setting="mode">
              <button class="btn active" data-value="engine">vs Computer</button>
              <button class="btn" data-value="local">Two Player</button>
            </div>
          </div>
          <div class="new-game-top-item engine-only">
            <label>Play as</label>
            <div class="btn-group" data-setting="color">
              <button class="btn active" data-value="w">White</button>
              <button class="btn" data-value="b">Black</button>
              <button class="btn" data-value="random">Random</button>
            </div>
          </div>
          <div class="new-game-top-item engine-only">
            <label>Game Type</label>
            <div class="btn-group" data-setting="rated">
              <button class="btn active" data-value="casual">Casual</button>
              <button class="btn" data-value="rated">Rated</button>
            </div>
          </div>
        </div>
        <div class="dialog-section engine-only">
          <label>Choose your opponent</label>
          <div class="bot-picker-layout">
            <div class="bot-picker-list" id="bot-picker-list"></div>
            <div class="bot-picker-detail" id="bot-picker-detail"></div>
          </div>
        </div>
        <div class="dialog-section tc-section">
          <label>Time Control</label>
          <div class="time-control-grid" id="time-control-grid">
            <div class="tc-compact-row">
              <button class="btn btn-sm tc-btn active" data-time="0" data-increment="0">None</button>
              <button class="btn btn-sm tc-btn" data-time="60" data-increment="0">&#9889;1</button>
              <button class="btn btn-sm tc-btn" data-time="60" data-increment="1">&#9889;1+1</button>
              <button class="btn btn-sm tc-btn" data-time="120" data-increment="1">&#9889;2+1</button>
              <button class="btn btn-sm tc-btn" data-time="180" data-increment="0">&#128293;3</button>
              <button class="btn btn-sm tc-btn" data-time="180" data-increment="2">&#128293;3+2</button>
              <button class="btn btn-sm tc-btn" data-time="300" data-increment="0">&#128293;5</button>
              <button class="btn btn-sm tc-btn" data-time="300" data-increment="3">&#128293;5+3</button>
              <button class="btn btn-sm tc-btn" data-time="600" data-increment="0">&#9201;10</button>
              <button class="btn btn-sm tc-btn" data-time="900" data-increment="10">&#9201;15+10</button>
              <button class="btn btn-sm tc-btn" data-time="1800" data-increment="0">&#9812;30</button>
              <button class="btn btn-sm tc-btn" data-time="2700" data-increment="15">&#9812;45+15</button>
              <button class="btn btn-sm tc-btn" data-time="custom" data-increment="0">&#9881;Custom</button>
            </div>
            <div class="tc-custom-inputs hidden" id="tc-custom-inputs">
              <div class="tc-custom-row">
                <label>FIDE Preset</label>
                <select id="tc-fide-preset" class="tc-select">
                  <option value="">Manual</option>
                  <optgroup label="Classical">
                    <option value="classical-90-30">G/90 + 30s</option>
                    <option value="classical-40-2h">40/2h + G/30 + 30s</option>
                    <option value="classical-40-90">40/90 + G/30 + 30s</option>
                  </optgroup>
                  <optgroup label="Rapid">
                    <option value="rapid-15-10">G/15 + 10s</option>
                    <option value="rapid-25-10">G/25 + 10s</option>
                  </optgroup>
                  <optgroup label="Blitz">
                    <option value="blitz-3-2">G/3 + 2s</option>
                    <option value="blitz-5-3">G/5 + 3s</option>
                  </optgroup>
                </select>
              </div>
              <div class="tc-custom-row">
                <label>Time</label>
                <input type="number" id="tc-custom-minutes" min="1" max="300" value="10" placeholder="min"> min
              </div>
              <div class="tc-custom-row">
                <label>For first</label>
                <input type="number" id="tc-custom-moves" min="0" max="80" value="0" placeholder="moves"> moves <span class="tc-hint">(0 = all)</span>
              </div>
              <div class="tc-custom-row tc-period2 hidden" id="tc-period2">
                <label>Then</label>
                <input type="number" id="tc-custom-minutes2" min="1" max="300" value="30" placeholder="min"> min
              </div>
              <div class="tc-custom-row">
                <label>Delay Type</label>
                <select id="tc-delay-type" class="tc-select">
                  <option value="fischer">Fischer increment</option>
                  <option value="bronstein">Bronstein delay</option>
                  <option value="none">No increment</option>
                </select>
              </div>
              <div class="tc-custom-row" id="tc-increment-row">
                <label>Increment</label>
                <input type="number" id="tc-custom-increment" min="0" max="60" value="0" placeholder="sec"> sec/move
              </div>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-new-game">Cancel</button>
          <button class="btn btn-primary" id="start-new-game">Start Game</button>
        </div>
      </div>
    </div>

    <!-- Promotion Dialog -->
    <div id="promotion-dialog" class="dialog-overlay hidden">
      <div class="dialog promotion-dialog">
        <h3>Promote pawn to:</h3>
        <div class="promotion-pieces">
          <button class="promotion-piece" data-piece="q"><img alt="Queen"></button>
          <button class="promotion-piece" data-piece="r"><img alt="Rook"></button>
          <button class="promotion-piece" data-piece="b"><img alt="Bishop"></button>
          <button class="promotion-piece" data-piece="n"><img alt="Knight"></button>
        </div>
      </div>
    </div>

    <!-- PGN Import Dialog -->
    <div id="pgn-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>PGN Import / Export</h2>
        <div class="pgn-file-row"><label class="btn btn-secondary pgn-file-label" for="pgn-file-input">Choose .pgn file(s)</label><input type="file" id="pgn-file-input" accept=".pgn,.txt" multiple hidden><span id="pgn-file-name" class="pgn-file-name"></span></div>
        <textarea id="pgn-input" placeholder="Paste PGN here or choose a file above..." rows="10"></textarea>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="btn-export-pgn">Export Current Game</button>
          <button class="btn btn-secondary" id="btn-export-gif">Export GIF</button>
          <button class="btn btn-secondary" id="cancel-pgn">Cancel</button>
          <button class="btn btn-primary" id="load-pgn">Import</button>
        </div>
      </div>
    </div>

    <!-- Database Browser Dialog -->
    <div id="database-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Game Database</h2>
        <div class="db-category-tabs" id="db-category-tabs">
          <button class="db-tab active" data-category="all">All</button>
        </div>
        <div class="db-controls">
          <input type="text" id="db-search" placeholder="Search by player, event, ECO...">
          <select id="db-collection">
            <option value="all">All Collections</option>
          </select>
          <button class="btn btn-sm" id="db-import-pgn" title="Import PGN file">+ Import</button>
        </div>
        <div id="db-results-summary" class="db-results-summary"></div>
        <div id="db-games-list" class="db-games-list"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-database">Close</button>
        </div>
      </div>
    </div>

    <!-- Stats / Profile Dialog -->
    <div id="stats-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Player Profile</h2>

        <!-- Profile Header -->
        <div class="profile-header" id="profile-header">
          <div class="profile-avatar-container">
            <img class="profile-avatar" id="profile-avatar" src="img/avatars/knight.svg" alt="Avatar">
            <button class="btn btn-sm profile-avatar-edit" id="btn-edit-avatar">Edit</button>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="profile-name">Player</div>
            <div class="profile-rating" id="profile-rating"></div>
            <div class="profile-record" id="profile-record"></div>
          </div>
        </div>

        <!-- Account Details (shown when logged in) -->
        <div id="profile-account-details" class="profile-account-details hidden"></div>

        <!-- Avatar Picker -->
        <div class="avatar-picker hidden" id="avatar-picker"></div>

        <!-- Rating Graph -->
        <div class="profile-section" id="rating-graph-section">
          <h3>Rating History</h3>
          <div id="rating-graph-container"></div>
        </div>

        <!-- Stats Content -->
        <div id="stats-content" class="stats-content"></div>

        <div class="dialog-actions">
          <button class="btn" id="btn-training-plan">Training Plan</button>
          <button class="btn btn-secondary" id="close-stats">Close</button>
        </div>
      </div>
    </div>

    <!-- Training Plan Dialog -->
    <div id="training-plan-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Training Plan</h2>
        <div id="training-plan-summary" class="tp-summary"></div>
        <div id="training-plan-focus" class="tp-focus-areas"></div>
        <div id="training-plan-weekly" class="tp-weekly"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-training-plan">Close</button>
        </div>
      </div>
    </div>

    <!-- Tournament Setup Dialog -->
    <div id="tournament-setup-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>New Tournament</h2>
        <div class="dialog-section">
          <label>Format</label>
          <div class="btn-group" id="tournament-format-group">
            <button class="btn active" data-value="round-robin">Round Robin</button>
            <button class="btn" data-value="knockout">Knockout</button>
          </div>
        </div>
        <div class="dialog-section">
          <label>Select Opponents</label>
          <div class="tournament-opponents" id="tournament-opponents"></div>
        </div>
        <div class="dialog-section">
          <label>Games per Match</label>
          <div class="btn-group" id="tournament-games-group">
            <button class="btn active" data-value="1">1</button>
            <button class="btn" data-value="2">2</button>
            <button class="btn" data-value="4">4</button>
          </div>
        </div>
        <div class="dialog-section">
          <label>Time Control</label>
          <div class="btn-group" id="tournament-time-group">
            <button class="btn active" data-time="0" data-increment="0">No Timer</button>
            <button class="btn" data-time="180" data-increment="2">3+2</button>
            <button class="btn" data-time="300" data-increment="3">5+3</button>
            <button class="btn" data-time="600" data-increment="0">10 min</button>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-tournament-setup">Cancel</button>
          <button class="btn btn-primary" id="start-tournament">Start Tournament</button>
        </div>
      </div>
    </div>

    <!-- Tournament Progress Dialog -->
    <div id="tournament-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2 id="tournament-title">Tournament</h2>
        <div id="tournament-content" class="tournament-content"></div>
        <div class="dialog-actions">
          <button class="btn btn-sm hidden" id="tournament-next-match">Play Next Match</button>
          <button class="btn btn-secondary" id="tournament-close">Close</button>
          <button class="btn btn-secondary" id="tournament-abandon">Abandon</button>
        </div>
      </div>
    </div>

    <!-- Admin Dialog -->
    <div id="admin-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Admin Panel</h2>
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="users">Users</button>
          <button class="admin-tab" data-tab="leaderboard">Leaderboard</button>
        </div>
        <div id="admin-content" class="admin-content"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-admin">Close</button>
        </div>
      </div>
    </div>

    <!-- Auth Dialog -->
    <div id="auth-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <!-- Login Form -->
        <div id="login-form">
          <h2>Login</h2>
          <div class="dialog-section">
            <label>Email</label>
            <input type="email" id="login-email" placeholder="your@email.com">
          </div>
          <div class="dialog-section">
            <label>Password</label>
            <input type="password" id="login-password" placeholder="Password">
          </div>
          <div class="auth-error hidden" id="login-error"></div>
          <div class="dialog-actions">
            <button class="btn btn-secondary" id="close-auth">Close</button>
            <button class="btn btn-primary" id="btn-login">Login</button>
          </div>
          <div class="auth-divider"><span>or</span></div>
          <button class="btn btn-magic-link" id="btn-magic-link">Send Magic Link (no password)</button>
          <div class="auth-magic-status hidden" id="magic-link-status"></div>
          <div class="auth-switch">
            <a href="#" id="show-forgot-password">Forgot password?</a>
          </div>
          <div class="auth-switch">
            Don't have an account? <a href="#" id="show-register">Register</a>
          </div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgot-password-form" class="hidden">
          <h2>Reset Password</h2>
          <p class="auth-desc">Enter your email and we'll send you a link to reset your password.</p>
          <div class="dialog-section">
            <label>Email</label>
            <input type="email" id="forgot-email" placeholder="your@email.com">
          </div>
          <div class="auth-error hidden" id="forgot-error"></div>
          <div class="auth-success hidden" id="forgot-success"></div>
          <div class="dialog-actions">
            <button class="btn btn-secondary" id="back-to-login-from-forgot">Back</button>
            <button class="btn btn-primary" id="btn-send-reset">Send Reset Link</button>
          </div>
        </div>

        <!-- Set New Password Form (shown after PASSWORD_RECOVERY redirect) -->
        <div id="set-new-password-form" class="hidden">
          <h2>Set New Password</h2>
          <p class="auth-desc">Enter your new password below.</p>
          <div class="dialog-section">
            <label>New Password</label>
            <input type="password" id="new-password-input" placeholder="New password (6+ chars)">
          </div>
          <div class="dialog-section">
            <label>Confirm Password</label>
            <input type="password" id="confirm-password-input" placeholder="Confirm new password">
          </div>
          <div class="auth-error hidden" id="new-password-error"></div>
          <div class="auth-success hidden" id="new-password-success"></div>
          <div class="dialog-actions">
            <button class="btn btn-primary" id="btn-set-new-password">Update Password</button>
          </div>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="hidden">
          <h2>Register</h2>
          <div class="dialog-section">
            <label>Display Name</label>
            <input type="text" id="register-name" placeholder="Your name">
          </div>
          <div class="dialog-section">
            <label>Email</label>
            <input type="email" id="register-email" placeholder="your@email.com">
          </div>
          <div class="dialog-section">
            <label>Password</label>
            <input type="password" id="register-password" placeholder="Password (6+ chars)">
          </div>
          <div class="auth-error hidden" id="register-error"></div>
          <div class="dialog-actions">
            <button class="btn btn-secondary" id="back-to-login">Back</button>
            <button class="btn btn-primary" id="btn-register">Register</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot Match Dialog -->
    <div id="bot-match-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-new-game">
        <h2>Bot vs Bot Match</h2>
        <div class="dialog-section">
          <label>White</label>
          <div class="bot-match-picker" id="bot-match-white"></div>
        </div>
        <div class="dialog-section">
          <label>Black</label>
          <div class="bot-match-picker" id="bot-match-black"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-bot-match">Cancel</button>
          <button class="btn btn-primary" id="start-bot-match">Watch Live</button>
        </div>
      </div>
    </div>

    <!-- Bot Match Progress Dialog -->
    <div id="bot-match-progress" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Simulating Game...</h2>
        <div class="bot-match-status" id="bot-match-status">Preparing...</div>
        <div class="progress-bar"><div class="progress-fill" id="bot-match-progress-fill"></div></div>
      </div>
    </div>

    <!-- Chess News Dialog -->
    <div id="news-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <div class="news-header" id="news-header">
          <h2>Chess World</h2>
          <div class="news-tabs">
            <button class="news-tab active" data-tab="live">Live & Upcoming</button>
            <button class="news-tab" data-tab="follow">Follow Chess</button>
          </div>
        </div>
        <div class="news-detail-header hidden" id="news-detail-header">
          <button class="btn btn-sm" id="news-back">&larr; Back</button>
          <span class="news-detail-title" id="news-detail-title"></span>
        </div>
        <div class="news-content" id="news-content">
          <div class="news-loading">Loading broadcasts...</div>
        </div>
        <div class="news-detail-view hidden" id="news-detail-view">
          <iframe id="news-iframe" class="news-iframe" sandbox="allow-scripts allow-same-origin" allowfullscreen></iframe>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-news">Close</button>
        </div>
      </div>
    </div>

    <!-- Music Player Dialog (Spotify-style 2-column) -->
    <div id="music-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-music-player">
        <div class="mp-layout">
          <!-- Left column: Composer sidebar -->
          <div class="mp-sidebar">
            <div class="mp-sidebar-header">
              <span class="mp-sidebar-title">Composers</span>
              <button class="btn btn-sm btn-secondary" id="mp-browse-composers" title="Browse all composers">Browse All</button>
            </div>
            <div class="mp-sidebar-list" id="composer-picker-list"></div>
          </div>
          <!-- Right column: Now Playing + Queue -->
          <div class="mp-main">
            <!-- Now Playing -->
            <div class="mp-now-playing">
              <img class="mp-portrait" id="mp-portrait" src="" alt="">
              <div class="mp-now-info">
                <div class="mp-track-title" id="mp-track-title">No track selected</div>
                <div class="mp-track-composer" id="mp-track-composer"></div>
              </div>
            </div>
            <!-- Controls + Progress -->
            <div class="mp-controls-section">
              <div class="mp-controls">
                <button class="btn btn-sm" id="music-shuffle" title="Shuffle">&#8645;</button>
                <button class="btn btn-sm" id="music-prev" title="Previous">&#9664;&#9664;</button>
                <button class="mp-play-btn" id="music-play-pause" title="Play/Pause">&#9654;</button>
                <button class="btn btn-sm" id="music-next" title="Next">&#9654;&#9654;</button>
                <button class="btn btn-sm" id="music-repeat" title="Repeat">&#8635;</button>
              </div>
              <div class="mp-progress-row">
                <span class="mp-time" id="mp-time-current">0:00</span>
                <input type="range" class="mp-progress-bar" id="mp-progress" min="0" max="1000" value="0">
                <span class="mp-time" id="mp-time-total">0:00</span>
              </div>
              <div class="mp-vol-row">
                <span class="music-vol-icon">&#128264;</span>
                <input type="range" id="mp-vol-slider" min="0" max="100" value="30" class="mp-volume-slider">
                <span class="music-vol-icon">&#128266;</span>
              </div>
            </div>
            <!-- Favorite Row -->
            <div class="music-favorite-row hidden" id="music-favorite-row">
              <span class="music-fav-label">&#9733; <strong id="music-fav-name"></strong></span>
              <button class="btn btn-small btn-secondary" id="music-clear-favorite">Clear</button>
            </div>
            <!-- Track Queue -->
            <div class="mp-queue-header">Up Next</div>
            <div class="mp-queue" id="composer-picker-detail"></div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-music">Close</button>
        </div>
      </div>
    </div>

    <!-- GM Browse Dialog -->
    <div id="gm-browse-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Hall of Champions</h2>
        <div class="gm-browse-subtitle">The legendary grandmasters who shaped the royal game</div>
        <div class="gm-browse-layout">
          <div class="gm-browse-list" id="gm-browse-list"></div>
          <div class="gm-browse-detail" id="gm-browse-detail"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-gm-browse">Close</button>
        </div>
      </div>
    </div>

    <!-- Composer Browse Dialog -->
    <div id="composer-browse-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>The Great Composers</h2>
        <div class="composer-browse-subtitle">Masters of melody who inspire the royal game</div>
        <div class="cmpb-search-row">
          <span class="cmpb-search-icon">&#128269;</span>
          <input type="text" id="composer-search" class="cmpb-search" placeholder="Search composers...">
        </div>
        <div class="composer-browse-layout">
          <div class="composer-browse-list" id="composer-browse-list"></div>
          <div class="composer-browse-detail" id="composer-browse-detail"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-composer-browse">Close</button>
        </div>
      </div>
    </div>

    <!-- Settings Dialog -->
    <!-- Settings: Sound Dialog -->
    <div id="settings-sound-dialog" class="dialog-overlay hidden">
      <div class="dialog settings-dialog">
        <h2>Sound & Music</h2>
        <div class="settings-section">
          <label class="settings-toggle-row">
            <span class="layout-toggle-label">Move Sounds</span>
            <span class="toggle-switch"><input type="checkbox" id="settings-sound"><span class="toggle-slider"></span></span>
          </label>
          <div class="settings-volume-row">
            <span class="layout-toggle-label">Sound Effects Volume</span>
            <div class="settings-volume-control">
              <span class="music-vol-icon">&#128264;</span>
              <input type="range" id="settings-sfx-volume" min="0" max="100" value="100" class="music-volume-slider">
              <span class="music-vol-icon">&#128266;</span>
            </div>
          </div>
          <div class="settings-toggle-row">
            <span class="layout-toggle-label">Voice Announcements <span class="label-experimental">(experimental)</span></span>
            <span style="display:flex;align-items:center;gap:6px;">
              <button class="btn btn-sm btn-secondary" id="settings-voice-test">Test</button>
              <label class="toggle-switch"><input type="checkbox" id="settings-voice"><span class="toggle-slider"></span></label>
            </span>
          </div>
          <div class="settings-volume-row">
            <span class="layout-toggle-label">Voice Volume</span>
            <div class="settings-volume-control">
              <span class="music-vol-icon">&#128264;</span>
              <input type="range" id="settings-voice-volume" min="0" max="100" value="100" class="music-volume-slider">
              <span class="music-vol-icon">&#128266;</span>
            </div>
          </div>
          <div class="settings-toggle-row">
            <span class="layout-toggle-label">Music Player</span>
            <span style="display:flex;align-items:center;gap:8px;">
              <button class="btn btn-sm btn-secondary" id="btn-music-dialog">Open</button>
              <label class="toggle-switch"><input type="checkbox" id="settings-music-toggle" checked><span class="toggle-slider"></span></label>
            </span>
          </div>
          <div class="settings-volume-row">
            <span class="layout-toggle-label">Music Volume</span>
            <div class="settings-volume-control">
              <span class="music-vol-icon">&#128264;</span>
              <input type="range" id="settings-music-volume" min="0" max="100" value="30" class="music-volume-slider">
              <span class="music-vol-icon">&#128266;</span>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-primary" id="close-settings-sound">Done</button>
        </div>
      </div>
    </div>

    <!-- Settings: Display Dialog -->
    <div id="settings-display-dialog" class="dialog-overlay hidden">
      <div class="dialog settings-dialog">
        <h2>Display</h2>
        <div class="settings-section">
          <div class="settings-subsection">
            <span class="settings-sublabel">Board Theme</span>
            <div class="board-theme-swatches" id="board-theme-swatches"></div>
          </div>
          <div class="settings-subsection">
            <span class="settings-sublabel">Piece Style</span>
            <div class="piece-theme-list" id="piece-theme-list"></div>
          </div>
          <div class="settings-subsection">
            <span class="settings-sublabel">Clock Style</span>
            <div class="clock-theme-list" id="clock-theme-list"></div>
          </div>
          <div class="settings-subsection">
            <span class="settings-sublabel">Color Mode</span>
            <div class="btn-group" id="color-mode-group">
              <button class="btn active" data-value="dark">Dark</button>
              <button class="btn" data-value="light">Light</button>
              <button class="btn" data-value="system">System</button>
            </div>
          </div>
          <div class="settings-subsection">
            <span class="settings-sublabel">Slogan</span>
            <select class="dialog-select" id="settings-slogan">
              <option value="Classical Brilliancy">Classical Brilliancy</option>
              <option value="Where Every Move Is a Masterpiece">Where Every Move Is a Masterpiece</option>
              <option value="Brilliance Has a Sound">Brilliance Has a Sound</option>
              <option value="Where Strategy Meets Symphony">Where Strategy Meets Symphony</option>
              <option value="Compose Your Victory">Compose Your Victory</option>
              <option value="Where Genius Plays">Where Genius Plays</option>
              <option value="The Sound of Brilliant Play">The Sound of Brilliant Play</option>
              <option value="Masters of the Board. Masters of the Score.">Masters of the Board. Masters of the Score.</option>
              <option value="Timeless Moves. Timeless Music.">Timeless Moves. Timeless Music.</option>
              <option value="The Classical Game">The Classical Game</option>
              <option value="Every Game a Composition">Every Game a Composition</option>
              <option value="Grand Moves. Grand Music.">Grand Moves. Grand Music.</option>
              <option value="Think in Moves. Feel in Music.">Think in Moves. Feel in Music.</option>
              <option value="Where Classics Reign">Where Classics Reign</option>
              <option value="Play Like a Master">Play Like a Master</option>
              <option value="Every Move Resonates">Every Move Resonates</option>
              <option value="The Beauty of the Brilliant Game">The Beauty of the Brilliant Game</option>
              <option value="Where Knights Dance and Notes Sing">Where Knights Dance and Notes Sing</option>
            </select>
          </div>
          <label class="settings-toggle-row">
            <span class="layout-toggle-label">Eval Bar</span>
            <span class="toggle-switch"><input type="checkbox" id="settings-eval-bar"><span class="toggle-slider"></span></span>
          </label>
          <label class="settings-toggle-row">
            <span class="layout-toggle-label">Coordinates</span>
            <span class="toggle-switch"><input type="checkbox" id="settings-coords" checked><span class="toggle-slider"></span></span>
          </label>
          <label class="settings-toggle-row">
            <span class="layout-toggle-label">Blunder Alerts</span>
            <span class="toggle-switch"><input type="checkbox" id="settings-blunder-alerts" checked><span class="toggle-slider"></span></span>
          </label>
          <label class="settings-toggle-row" style="flex-direction:column;align-items:flex-start;gap:4px">
            <span class="layout-toggle-label">Takeback Policy</span>
            <select id="settings-takeback-policy" class="settings-select" style="width:100%;padding:4px 8px;border-radius:4px;background:var(--bg);color:var(--text);border:1px solid var(--border, #444)">
              <option value="personality">Personality-based</option>
              <option value="always">Always allow</option>
              <option value="never">Never allow</option>
            </select>
          </label>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-primary" id="close-settings-display">Done</button>
        </div>
      </div>
    </div>

    <!-- Settings: Board Dialog -->
    <div id="settings-board-dialog" class="dialog-overlay hidden">
      <div class="dialog settings-dialog">
        <h2>Board</h2>
        <div class="settings-section">
          <label class="settings-toggle-row">
            <span class="layout-toggle-label">Flip Board</span>
            <span class="toggle-switch"><input type="checkbox" id="settings-flip"><span class="toggle-slider"></span></span>
          </label>
          <h4 class="settings-section-title" style="margin-top:14px;">DGT Board</h4>
          <div class="dgt-status-indicator" id="dgt-status-indicator">
            <span class="dgt-status-dot" id="dgt-status-dot"></span>
            <span id="dgt-status-text">Not connected</span>
          </div>
          <div class="dgt-connect-options" id="dgt-connect-options">
            <button class="dgt-connect-btn" id="dgt-connect-usb">
              <div class="dgt-connect-title">USB (Web Serial)</div>
              <div class="dgt-connect-desc">Direct USB connection. Chrome/Edge only.</div>
            </button>
            <button class="dgt-connect-btn" id="dgt-connect-livechess">
              <div class="dgt-connect-title">DGT LiveChess</div>
              <div class="dgt-connect-desc">Connect via LiveChess 2 software (WebSocket).</div>
            </button>
            <button class="dgt-connect-btn" id="dgt-connect-pegasus">
              <div class="dgt-connect-title">DGT Pegasus</div>
              <div class="dgt-connect-desc">Connect via Bluetooth (BLE).</div>
            </button>
          </div>
          <div class="dgt-engine-move hidden" id="dgt-engine-move">
            <div class="dgt-engine-move-label">Play this move on your board:</div>
            <div class="dgt-engine-move-san" id="dgt-engine-move-san"></div>
          </div>
          <div class="dgt-connected-actions hidden" id="dgt-connected-actions">
            <button class="btn btn-secondary" id="dgt-disconnect">Disconnect</button>
            <button class="btn btn-secondary" id="dgt-reset-board">Reset Board</button>
          </div>
          <div class="dgt-hardware-settings hidden" id="dgt-hardware-settings">
            <h5 class="dgt-hw-title">LED Settings</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Brightness</span>
              <input type="range" id="dgt-led-brightness" min="1" max="5" step="1" value="2">
              <span class="dgt-hw-value" id="dgt-led-brightness-val">2</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Speed</span>
              <input type="range" id="dgt-led-speed" min="1" max="5" step="1" value="3">
              <span class="dgt-hw-value" id="dgt-led-speed-val">3</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Flash (ms)</span>
              <input type="range" id="dgt-flash-duration" min="200" max="2000" step="100" value="600">
              <span class="dgt-hw-value" id="dgt-flash-duration-val">600</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">My moves</span>
              <select id="dgt-player-led-mode" class="dgt-hw-select">
                <option value="both">From + To</option>
                <option value="from">From only</option>
                <option value="to">To only</option>
              </select>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Engine moves</span>
              <select id="dgt-engine-led-mode" class="dgt-hw-select">
                <option value="sequential">Sequential (from, then to)</option>
                <option value="both">From + To</option>
                <option value="to">To only</option>
              </select>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Castle delay (ms)</span>
              <input type="range" id="dgt-castle-delay" min="500" max="5000" step="250" value="2000">
              <span class="dgt-hw-value" id="dgt-castle-delay-val">2000</span>
            </label>
            <h5 class="dgt-hw-title" style="margin-top:12px">Timing</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Debounce (ms)</span>
              <input type="range" id="dgt-debounce" min="100" max="1000" step="50" value="300">
              <span class="dgt-hw-value" id="dgt-debounce-val">300</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Poll interval (ms)</span>
              <input type="range" id="dgt-poll-interval" min="200" max="2000" step="100" value="500">
              <span class="dgt-hw-value" id="dgt-poll-interval-val">500</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Move cooldown (ms)</span>
              <input type="range" id="dgt-move-cooldown" min="200" max="3000" step="100" value="800">
              <span class="dgt-hw-value" id="dgt-move-cooldown-val">800</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">New game delay (ms)</span>
              <input type="range" id="dgt-start-pos-delay" min="500" max="5000" step="250" value="2000">
              <span class="dgt-hw-value" id="dgt-start-pos-delay-val">2000</span>
            </label>
            <h5 class="dgt-hw-title" style="margin-top:12px">Behavior</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Voice announce</span>
              <input type="checkbox" id="dgt-voice-enabled" checked>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Auto new game</span>
              <input type="checkbox" id="dgt-auto-new-game" checked>
            </label>
            <h5 class="dgt-hw-title" style="margin-top:12px">Sync & Detection</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Sync tolerance (squares)</span>
              <input type="range" id="dgt-sync-tolerance" min="0" max="6" step="1" value="2">
              <span class="dgt-hw-value" id="dgt-sync-tolerance-val">2</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Out-of-sync threshold</span>
              <input type="range" id="dgt-oos-threshold" min="2" max="10" step="1" value="4">
              <span class="dgt-hw-value" id="dgt-oos-threshold-val">4</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Sync warning delay (ms)</span>
              <input type="range" id="dgt-sync-warning" min="1000" max="15000" step="500" value="5000">
              <span class="dgt-hw-value" id="dgt-sync-warning-val">5000</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Init delay (ms)</span>
              <input type="range" id="dgt-init-delay" min="50" max="1000" step="50" value="200">
              <span class="dgt-hw-value" id="dgt-init-delay-val">200</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Board dump wait (ms)</span>
              <input type="range" id="dgt-dump-wait" min="200" max="2000" step="100" value="500">
              <span class="dgt-hw-value" id="dgt-dump-wait-val">500</span>
            </label>
            <h5 class="dgt-hw-title" style="margin-top:12px">Connection</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">LiveChess URL</span>
              <input type="text" id="dgt-livechess-url" class="dgt-hw-input" value="ws://localhost:1982/api/v1.0">
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">LiveChess timeout (ms)</span>
              <input type="range" id="dgt-livechess-timeout" min="1000" max="15000" step="500" value="5000">
              <span class="dgt-hw-value" id="dgt-livechess-timeout-val">5000</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">BLE timeout (ms)</span>
              <input type="range" id="dgt-ble-timeout" min="3000" max="30000" step="1000" value="10000">
              <span class="dgt-hw-value" id="dgt-ble-timeout-val">10000</span>
            </label>
            <h5 class="dgt-hw-title" style="margin-top:12px">Voice</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Speech rate</span>
              <input type="range" id="dgt-speech-rate" min="0.5" max="2.0" step="0.05" value="0.95">
              <span class="dgt-hw-value" id="dgt-speech-rate-val">0.95</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Speech pitch</span>
              <input type="range" id="dgt-speech-pitch" min="0.5" max="2.0" step="0.1" value="1.0">
              <span class="dgt-hw-value" id="dgt-speech-pitch-val">1.0</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Speech volume</span>
              <input type="range" id="dgt-speech-volume" min="0" max="1.0" step="0.1" value="1.0">
              <span class="dgt-hw-value" id="dgt-speech-volume-val">1.0</span>
            </label>
            <button class="btn btn-small btn-secondary" id="dgt-reset-defaults">Reset Defaults</button>
          </div>

          <h4 class="settings-section-title" style="margin-top:18px;">ChessUp Board</h4>
          <div class="dgt-status-indicator" id="cu-status-indicator">
            <span class="dgt-status-dot" id="cu-status-dot"></span>
            <span id="cu-status-text">Not connected</span>
          </div>
          <div class="dgt-connect-options" id="cu-connect-options">
            <button class="dgt-connect-btn" id="cu-connect-ble">
              <div class="dgt-connect-title">ChessUp (BLE)</div>
              <div class="dgt-connect-desc">Connect via Bluetooth Low Energy.</div>
            </button>
          </div>
          <div class="dgt-connected-actions hidden" id="cu-connected-actions">
            <button class="btn btn-secondary" id="cu-disconnect">Disconnect</button>
            <button class="btn btn-secondary" id="cu-reset-board">Reset Board</button>
          </div>
          <div class="cu-hardware-settings" id="cu-hardware-settings">
            <h5 class="dgt-hw-title">Display</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">LED Brightness</span>
              <input type="range" id="cu-led-brightness" min="1" max="5" step="1" value="3">
              <span class="dgt-hw-value" id="cu-led-brightness-val">3</span>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Assistance Level</span>
              <select id="cu-assistance-level" class="dgt-hw-select">
                <option value="none">None</option>
                <option value="beginner">Beginner</option>
                <option value="casual">Casual</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
                <option value="master">Master</option>
              </select>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">My moves</span>
              <select id="cu-player-led-mode" class="dgt-hw-select">
                <option value="both">From + To</option>
                <option value="from">From only</option>
                <option value="to">To only</option>
              </select>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Engine moves</span>
              <select id="cu-engine-led-mode" class="dgt-hw-select">
                <option value="sequential">Sequential (from, then to)</option>
                <option value="both">From + To</option>
                <option value="to">To only</option>
              </select>
            </label>
            <h5 class="dgt-hw-title" style="margin-top:12px">Timing</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Move delay (ms)</span>
              <input type="range" id="cu-move-delay" min="0" max="2000" step="50" value="300">
              <span class="dgt-hw-value" id="cu-move-delay-val">300</span>
            </label>
            <h5 class="dgt-hw-title" style="margin-top:12px">Connection</h5>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">Auto-reconnect</span>
              <input type="checkbox" id="cu-auto-reconnect" checked>
            </label>
            <label class="dgt-hw-row">
              <span class="dgt-hw-label">BLE timeout (ms)</span>
              <input type="range" id="cu-ble-timeout" min="3000" max="30000" step="1000" value="10000">
              <span class="dgt-hw-value" id="cu-ble-timeout-val">10000</span>
            </label>
            <button class="btn btn-small btn-secondary" id="cu-discover-services" style="margin-top:8px">Discover Services</button>
            <div class="cu-services-panel hidden" id="cu-services-panel">
              <pre class="cu-services-output" id="cu-services-output"></pre>
            </div>
            <button class="btn btn-small btn-secondary" id="cu-reset-defaults" style="margin-top:8px">Reset Defaults</button>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-primary" id="close-settings-board">Done</button>
        </div>
      </div>
    </div>

    <!-- Multi-Bot Analysis Dialog -->
    <div id="multi-analysis-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Analysis Lines</h2>
        <p class="multi-analysis-desc">See how different grandmasters and bots would play this position.</p>
        <div class="multi-analysis-bots" id="multi-analysis-bots"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-multi-analysis">Close</button>
          <button class="btn btn-primary" id="run-multi-analysis">Analyze Position</button>
        </div>
        <div class="multi-analysis-results hidden" id="multi-analysis-results"></div>
      </div>
    </div>

    <!-- Coach Settings Dialog -->
    <div id="coach-settings-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Coach Settings</h2>
        <div class="dialog-section">
          <label>Coaching Tier</label>
          <div class="btn-group" id="coach-tier-group">
            <button class="btn active" data-value="1">Stockfish Tips</button>
            <button class="btn" data-value="2">In-Browser AI</button>
            <button class="btn" data-value="3">API Key</button>
          </div>
        </div>
        <div class="dialog-section hidden" id="coach-webllm-section">
          <label>In-Browser AI (WebLLM)</label>
          <p class="coach-info" id="coach-webllm-info">Runs a small AI model directly in your browser. Free, no API key needed. Requires WebGPU (Chrome 113+).</p>
          <button class="btn btn-sm" id="coach-load-webllm">Load Model</button>
          <div class="coach-progress hidden" id="coach-webllm-progress">
            <div class="progress-bar"><div class="progress-fill" id="coach-webllm-progress-fill"></div></div>
            <span class="progress-text" id="coach-webllm-progress-text"></span>
          </div>
        </div>
        <div class="dialog-section hidden" id="coach-api-section">
          <label>API Configuration</label>
          <div class="coach-api-form">
            <div class="form-row">
              <label>Provider</label>
              <select id="coach-api-provider">
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic (Claude)</option>
              </select>
            </div>
            <div class="form-row">
              <label>API Key</label>
              <input type="password" id="coach-api-key" placeholder="Enter your API key">
            </div>
            <div class="form-row">
              <label>Model (optional)</label>
              <input type="text" id="coach-api-model" placeholder="e.g., gpt-4o-mini">
            </div>
            <button class="btn btn-sm btn-primary" id="coach-api-save">Save</button>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-coach-settings">Close</button>
        </div>
      </div>
    </div>


    <!-- Multiplayer Dialog -->
    <div id="multiplayer-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Play Online</h2>
        <div id="mp-login-required" class="hidden">
          <p style="text-align:center;color:#888;padding:12px 0;">You must be logged in to play online.</p>
          <div class="dialog-actions">
            <button class="btn btn-secondary" id="mp-cancel-login">Cancel</button>
          </div>
        </div>
        <div id="mp-menu">
          <div class="dialog-section">
            <label>Play as</label>
            <div class="btn-group" id="mp-color-group">
              <button class="btn active" data-value="w">White</button>
              <button class="btn" data-value="b">Black</button>
              <button class="btn" data-value="random">Random</button>
            </div>
          </div>
          <div class="dialog-section">
            <label>Time Control</label>
            <div class="btn-group" id="mp-time-group">
              <button class="btn active" data-time="0" data-increment="0">No Timer</button>
              <button class="btn" data-time="300" data-increment="0">5 min</button>
              <button class="btn" data-time="600" data-increment="0">10 min</button>
              <button class="btn" data-time="300" data-increment="3">5+3</button>
            </div>
          </div>
          <div class="dialog-actions">
            <button class="btn btn-primary" id="mp-create">Create Game</button>
          </div>
          <div class="mp-divider">&mdash; or join an existing game &mdash;</div>
          <div class="dialog-section">
            <label>Game Code</label>
            <input type="text" id="mp-join-code" placeholder="Enter 6-character code" maxlength="6">
          </div>
          <div class="dialog-actions">
            <button class="btn btn-primary" id="mp-join">Join Game</button>
            <button class="btn btn-secondary" id="mp-cancel">Cancel</button>
          </div>
        </div>
        <div id="mp-waiting" class="hidden">
          <p style="text-align:center;">Waiting for opponent...</p>
          <div class="mp-code-display" id="mp-code-display"></div>
          <p class="mp-code-hint">Share the link or code with your opponent</p>
          <div class="dialog-actions" style="flex-direction:column;gap:8px;">
            <button class="btn btn-primary" id="mp-copy-link">Copy Invite Link</button>
            <button class="btn btn-secondary" id="mp-cancel-waiting">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Draw Offer Dialog -->
    <div id="draw-offer-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Draw Offer</h2>
        <p style="text-align:center;">Your opponent offers a draw.</p>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="draw-decline">Decline</button>
          <button class="btn btn-primary" id="draw-accept">Accept</button>
        </div>
      </div>
    </div>

    <!-- Puzzle Dialog -->
    <div id="puzzle-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Puzzles</h2>
        <div class="puzzle-stats-summary" id="puzzle-stats-summary"></div>
        <div class="dialog-section">
          <label>Theme</label>
          <select id="puzzle-theme-filter" class="dialog-select">
            <option value="all">All Themes</option>
            <option value="mate">Checkmate</option>
            <option value="fork">Fork</option>
            <option value="pin">Pin</option>
            <option value="skewer">Skewer</option>
            <option value="discovery">Discovered Attack</option>
            <option value="deflection">Deflection</option>
            <option value="sacrifice">Sacrifice</option>
            <option value="endgame">Endgame</option>
            <option value="promotion">Promotion</option>
            <option value="back-rank">Back Rank</option>
            <option value="zwischenzug">Zwischenzug</option>
            <option value="trapped-piece">Trapped Piece</option>
            <option value="double-check">Double Check</option>
          </select>
        </div>
        <div class="dialog-section">
          <label>Difficulty</label>
          <div class="btn-group" id="puzzle-difficulty-group">
            <button class="btn active" data-value="all">All</button>
            <button class="btn" data-value="beginner">Beginner</button>
            <button class="btn" data-value="intermediate">Intermediate</button>
            <button class="btn" data-value="advanced">Advanced</button>
            <button class="btn" data-value="expert">Expert</button>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-puzzle">Cancel</button>
          <button class="btn" id="btn-daily-puzzle">Daily Puzzle</button>
          <button class="btn btn-primary" id="start-puzzle">Random Puzzle</button>
        </div>
      </div>
    </div>

    <!-- Endgame Trainer Dialog -->
    <div id="endgame-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Endgame Trainer</h2>
        <div class="endgame-stats-summary" id="endgame-stats-summary"></div>
        <div class="endgame-categories" id="endgame-categories">
          <!-- Rendered by JS: category cards with progress bars -->
        </div>
        <div class="endgame-positions hidden" id="endgame-positions">
          <button class="btn btn-sm" id="endgame-back">&larr; Back</button>
          <h3 id="endgame-category-title"></h3>
          <div class="endgame-position-list" id="endgame-position-list"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn" id="cancel-endgame">Close</button>
        </div>
      </div>
    </div>

    <!-- Game Review Dialog -->
    <div id="review-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide review-dialog">
        <div class="review-header" id="review-header">
          <div class="review-result-icon" id="review-result-icon"></div>
          <h2 id="review-result-text">Game Over</h2>
          <div class="review-result-detail" id="review-result-detail"></div>
        </div>
        <div class="review-accuracy" id="review-accuracy">
          <div class="review-accuracy-player">
            <div class="review-accuracy-label" id="review-white-name">White</div>
            <div class="review-accuracy-bar-container">
              <div class="review-accuracy-bar" id="review-white-bar"></div>
            </div>
            <div class="review-accuracy-pct" id="review-white-pct">0%</div>
          </div>
          <div class="review-accuracy-player">
            <div class="review-accuracy-label" id="review-black-name">Black</div>
            <div class="review-accuracy-bar-container">
              <div class="review-accuracy-bar review-accuracy-bar-black" id="review-black-bar"></div>
            </div>
            <div class="review-accuracy-pct" id="review-black-pct">0%</div>
          </div>
        </div>
        <div class="review-breakdown" id="review-breakdown"></div>
        <div class="review-critical" id="review-critical">
          <h3>Key Moments</h3>
          <div class="review-moments-list" id="review-moments-list"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="review-close">Close</button>
          <button class="btn btn-primary" id="review-step-through">Review Moves</button>
        </div>
      </div>
    </div>

    <!-- Move Analysis Tooltip -->
    <div id="move-tooltip" class="move-tooltip hidden"></div>

    <!-- Position Editor Dialog -->
    <div id="position-editor-dialog" class="dialog-overlay hidden">
      <div class="dialog pos-editor-dialog">
        <div class="dialog-header">
          <h3>Position Editor</h3>
          <button class="dialog-close" id="pos-editor-close">&times;</button>
        </div>
        <div class="pos-editor-layout">
          <div class="pos-editor-palette" id="pos-editor-palette"></div>
          <div class="pos-editor-board-wrap">
            <div class="pos-editor-board" id="pos-editor-board"></div>
          </div>
          <div class="pos-editor-controls">
            <label class="pos-editor-label">Side to move</label>
            <div class="pos-editor-turn-toggle">
              <button class="btn btn-sm pos-turn-btn selected" data-turn="w" id="pos-turn-w">White</button>
              <button class="btn btn-sm pos-turn-btn" data-turn="b" id="pos-turn-b">Black</button>
            </div>
            <label class="pos-editor-label">Castling</label>
            <div class="pos-editor-castling">
              <label><input type="checkbox" id="pos-castle-K" checked> K</label>
              <label><input type="checkbox" id="pos-castle-Q" checked> Q</label>
              <label><input type="checkbox" id="pos-castle-k" checked> k</label>
              <label><input type="checkbox" id="pos-castle-q" checked> q</label>
            </div>
            <label class="pos-editor-label">FEN</label>
            <input type="text" class="pos-fen-field" id="pos-fen-field" spellcheck="false">
            <div class="pos-editor-quick">
              <button class="btn btn-sm" id="pos-clear">Clear Board</button>
              <button class="btn btn-sm" id="pos-start">Starting Position</button>
            </div>
            <div class="pos-editor-actions">
              <button class="btn" id="pos-cancel">Cancel</button>
              <button class="btn" id="pos-analyze">Analyze</button>
              <button class="btn btn-primary" id="pos-play">Play from here</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Board Scanner Dialog -->
    <div id="scanner-dialog" class="dialog-overlay hidden">
      <div class="dialog scanner-dialog">
        <div class="dialog-header">
          <h3>Board Scanner</h3>
          <button class="dialog-close" id="scanner-close">&times;</button>
        </div>

        <!-- Phase 1: Camera -->
        <div id="scanner-camera-phase">
          <div class="scanner-preview-wrap">
            <video id="scanner-video" autoplay playsinline muted></video>
            <canvas id="scanner-overlay"></canvas>
          </div>
          <div class="scanner-controls">
            <div class="scanner-orient-row">
              <span class="scanner-label">Orientation</span>
              <div class="btn-group">
                <button class="btn btn-sm scanner-orient-btn active" data-orient="w">White</button>
                <button class="btn btn-sm scanner-orient-btn" data-orient="b">Black</button>
              </div>
            </div>
            <div class="scanner-actions">
              <button class="btn btn-sm" id="scanner-calibrate">Calibrate Empty</button>
              <button class="btn btn-primary" id="scanner-scan">Scan</button>
            </div>
            <p class="scanner-hint">Align your board with the grid. Drag to move, drag corners to resize.</p>
          </div>
        </div>

        <!-- Phase 2: Results -->
        <div id="scanner-results-phase" class="hidden">
          <div class="scanner-mini-board" id="scanner-mini-board"></div>
          <div class="scanner-result-controls">
            <div class="scanner-fen-row">
              <label class="scanner-label">FEN</label>
              <input type="text" id="scanner-fen" class="scanner-fen-field" spellcheck="false">
            </div>
            <div class="scanner-meta-row">
              <span class="scanner-confidence" id="scanner-confidence"></span>
              <div class="scanner-turn-row">
                <span class="scanner-label">Turn</span>
                <div class="btn-group">
                  <button class="btn btn-sm scanner-turn-btn active" data-turn="w">W</button>
                  <button class="btn btn-sm scanner-turn-btn" data-turn="b">B</button>
                </div>
              </div>
            </div>
            <p class="scanner-hint">Click squares to cycle pieces. Long-press to clear.</p>
            <div class="scanner-actions">
              <button class="btn btn-sm" id="scanner-rescan">Rescan</button>
              <button class="btn btn-sm" id="scanner-to-editor">Edit in Position Editor</button>
              <button class="btn btn-primary btn-sm" id="scanner-play">Play from here</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header>
      <div class="header-brand">
        <img src="assets/logo.svg" alt="Grandmasters" class="header-logo">
        <div class="header-titles">
          <h1>Grandmasters</h1>
          <span class="header-slogan" id="header-slogan">Classical Brilliancy</span>
        </div>
      </div>
      <nav>
        <button class="btn" id="btn-new-game">New Game</button>
        <button class="btn header-user-badge" id="btn-user-badge">
          <img class="header-user-avatar hidden" id="header-user-avatar" src="img/avatars/knight.svg" alt="">
          <span class="header-user-name" id="header-user-name">Login</span>
        </button>
        <button class="btn btn-panels-toggle" id="btn-panels-toggle" title="Panels">&#9881;</button>
        <button class="btn nav-menu-toggle" id="btn-menu-toggle" aria-label="Menu">
          <span class="menu-icon"></span>
        </button>
        <!-- Panels dropdown -->
        <div class="panels-dropdown hidden" id="panels-dropdown">
          <div class="panels-tabs">
            <button class="panels-tab active" data-panels-tab="board">Board</button>
            <button class="panels-tab" data-panels-tab="windows">Windows</button>
            <button class="panels-tab" data-panels-tab="options">Options</button>
          </div>
          <div class="panels-tab-content" id="panels-box">
            <div class="panels-section" data-panels-section="board">
              <label class="layout-toggle-row"><span class="layout-toggle-label">Eval Bar</span><span class="toggle-switch"><input type="checkbox" data-layout-key="evalBar"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Black</span><span class="toggle-switch"><input type="checkbox" data-layout-key="playerInfoTop"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">White</span><span class="toggle-switch"><input type="checkbox" data-layout-key="playerInfoBottom"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Captured</span><span class="toggle-switch"><input type="checkbox" data-layout-key="capturedPieces"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Timers</span><span class="toggle-switch"><input type="checkbox" data-layout-key="timers"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Navigation</span><span class="toggle-switch"><input type="checkbox" data-layout-key="navControls"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Opening</span><span class="toggle-switch"><input type="checkbox" data-layout-key="openingLabel"><span class="toggle-slider"></span></span></label>
            </div>
            <div class="panels-section hidden" data-panels-section="windows">
              <label class="layout-toggle-row"><span class="layout-toggle-label">Status</span><span class="toggle-switch"><input type="checkbox" data-layout-key="statusBar"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Eval Graph</span><span class="toggle-switch"><input type="checkbox" data-layout-key="evalGraph"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Clock</span><span class="toggle-switch"><input type="checkbox" data-layout-key="clockWindow"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Move List</span><span class="toggle-switch"><input type="checkbox" data-layout-key="moveList"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Book</span><span class="toggle-switch"><input type="checkbox" data-layout-key="openingExplorer"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">GM Hints</span><span class="toggle-switch"><input type="checkbox" data-layout-key="advisorsTab"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">GM Coach</span><span class="toggle-switch"><input type="checkbox" data-layout-key="coachTab"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Commentary</span><span class="toggle-switch"><input type="checkbox" data-layout-key="coachArea"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Music</span><span class="toggle-switch"><input type="checkbox" data-layout-key="music"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Move Notes</span><span class="toggle-switch"><input type="checkbox" data-layout-key="moveNotes"><span class="toggle-slider"></span></span></label>
              <label class="layout-toggle-row"><span class="layout-toggle-label">Match Notes</span><span class="toggle-switch"><input type="checkbox" data-layout-key="matchNotes"><span class="toggle-slider"></span></span></label>
            </div>
            <div class="panels-section hidden" data-panels-section="options">
              <label class="layout-toggle-row"><span class="layout-toggle-label">Legal Moves</span><span class="toggle-switch"><input type="checkbox" data-layout-key="showLegalMoves"><span class="toggle-slider"></span></span></label>
              <div class="layout-presets" style="margin-top:8px">
                <div class="layout-presets-header">
                  <span class="layout-toggle-label">Saved Layouts</span>
                  <button class="btn btn-xs" id="layout-save" title="Save current layout">Save</button>
                </div>
                <div class="layout-presets-list" id="layout-presets-list"></div>
              </div>
              <button class="btn btn-sm btn-accent" id="layout-auto-arrange" style="margin-top:6px;width:100%">Auto-Arrange</button>
              <button class="btn btn-sm btn-secondary" id="layout-reset" style="margin-top:6px;width:100%">Reset to Defaults</button>
            </div>
          </div>
        </div>
        <div class="nav-menu-backdrop" id="nav-menu-backdrop"></div>
        <div class="nav-menu" id="nav-menu">
          <div class="nav-menu-section">
            <span class="nav-menu-label">Play</span>
            <button class="btn" id="btn-play-online">Play Online</button>
            <button class="btn" id="btn-puzzles">Puzzles</button>
            <button class="btn" id="btn-endgames">Endgames</button>
            <button class="btn" id="btn-tournament">Tournament</button>
            <button class="btn" id="btn-bot-match">Bot Match</button>
            <button class="btn" id="btn-repertoire">Repertoire</button>
          </div>
          <div class="nav-menu-section">
            <span class="nav-menu-label">Tools</span>
            <button class="btn" id="btn-database">Database</button>
            <button class="btn" id="btn-stats">Stats</button>
            <button class="btn" id="btn-history">History</button>
            <button class="btn" id="btn-import-pgn">PGN Import/Export</button>
            <button class="btn" id="btn-position-editor">Position Editor</button>
            <button class="btn" id="btn-board-scanner">Board Scanner</button>
            <button class="btn" id="btn-lichess-import">Lichess Import</button>
            <button class="btn" id="btn-saved-games">Saved Games</button>
          </div>
          <div class="nav-menu-section">
            <span class="nav-menu-label">Discover</span>
            <button class="btn" id="btn-news">Chess World</button>
            <button class="btn" id="btn-gm-browse">Grandmasters</button>
            <button class="btn" id="btn-composers-browse">Composers</button>
          </div>
          <div class="nav-menu-section">
            <span class="nav-menu-label">Settings</span>
            <button class="btn" id="btn-settings-sound">Sound & Music</button>
            <button class="btn" id="btn-settings-display">Display</button>
            <button class="btn" id="btn-settings-board">Board</button>
            <button class="btn" id="btn-settings-layout">Panels</button>
          </div>
          <div class="nav-menu-section">
            <button class="btn hidden" id="btn-admin">Admin</button>
            <span class="auth-status hidden" id="auth-status"></span>
            <button class="btn" id="btn-auth">Login</button>
          </div>
          <div class="nav-menu-version" id="app-version">v152</div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main>
      <!-- Left: Board Area -->
      <div class="board-area">
        <div class="drag-group" data-drag-id="player-top" data-drag-label="Player Top">
        <!-- Top Player Info -->
        <div class="player-info top" id="player-top">
          <div class="player-info-left">
            <span class="player-name">Black</span>
            <span class="captured-pieces" id="captured-top"></span>
            <span class="material-advantage" id="material-top"></span>
          </div>
          <div class="timer-group">
            <span class="move-clock" id="move-clock-top">0s</span>
            <span class="timer" id="timer-top">--:--</span>
          </div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="board" data-drag-label="Board">
        <!-- Chess Board -->
        <div id="board-container">
          <div class="eval-bar" id="eval-bar">
            <div class="eval-bar-white" id="eval-bar-white"></div>
            <div class="eval-bar-label" id="eval-bar-label">0.0</div>
            <div class="tablebase-indicator hidden" id="tablebase-indicator">
              <span class="tb-badge" id="tb-badge"></span>
              <span class="tb-detail" id="tb-detail"></span>
              <span class="tb-move" id="tb-move"></span>
            </div>
            <div id="accuracy-bars" class="accuracy-bars hidden">
              <div class="accuracy-bar-row">
                <span class="accuracy-bar-label">W</span>
                <div class="accuracy-bar-track"><div class="accuracy-bar-fill accuracy-bar-white" id="accuracy-bar-white"></div></div>
                <span class="accuracy-bar-pct" id="accuracy-pct-white">—</span>
              </div>
              <div class="accuracy-bar-row">
                <span class="accuracy-bar-label">B</span>
                <div class="accuracy-bar-track"><div class="accuracy-bar-fill accuracy-bar-black" id="accuracy-bar-black"></div></div>
                <span class="accuracy-bar-pct" id="accuracy-pct-black">—</span>
              </div>
            </div>
          </div>
          <div class="coords coords-ranks" id="coords-ranks"></div>
          <div id="board" class="board"></div>
          <!-- Coordinate labels -->
          <div class="coords coords-files" id="coords-files"></div>
        </div>
        <!-- Puzzle Bar (shown during puzzle mode) -->
        <div class="puzzle-bar hidden" id="puzzle-bar">
          <div class="puzzle-info">
            <span class="puzzle-rating-badge" id="puzzle-rating-badge"></span>
            <span class="puzzle-theme-badge" id="puzzle-theme-badge"></span>
            <span class="puzzle-streak" id="puzzle-streak"></span>
          </div>
          <div class="puzzle-controls">
            <button class="btn btn-sm" id="btn-puzzle-hint">Hint</button>
            <button class="btn btn-sm" id="btn-puzzle-skip">Skip</button>
            <button class="btn btn-sm btn-primary hidden" id="btn-puzzle-next">Next</button>
          </div>
        </div>
        <!-- Endgame Trainer Bar (shown during endgame training) -->
        <div class="endgame-bar hidden" id="endgame-bar">
          <div class="endgame-info">
            <span class="endgame-rating-badge" id="endgame-rating-badge"></span>
            <span class="endgame-title-badge" id="endgame-title-badge"></span>
            <span class="endgame-objective" id="endgame-objective"></span>
          </div>
          <div class="endgame-controls">
            <button class="btn btn-sm" id="btn-endgame-hint">Hint</button>
            <button class="btn btn-sm" id="btn-endgame-retry">Retry</button>
            <button class="btn btn-sm hidden" id="btn-endgame-next">Next</button>
            <button class="btn btn-sm" id="btn-endgame-exit">Exit</button>
          </div>
        </div>
        <!-- Repertoire Drill Bar -->
        <div class="repertoire-drill-bar hidden" id="repertoire-drill-bar">
          <div class="rep-drill-info">
            <span class="rep-drill-name" id="rep-drill-name"></span>
            <span class="rep-drill-progress" id="rep-drill-progress"></span>
          </div>
          <div class="rep-drill-controls">
            <button class="btn btn-sm" id="btn-rep-drill-exit">Exit Drill</button>
          </div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="player-bottom" data-drag-label="Player Bottom">
        <!-- Bottom Player Info -->
        <div class="player-info bottom" id="player-bottom">
          <div class="player-info-left">
            <span class="player-name">White</span>
            <span class="captured-pieces" id="captured-bottom"></span>
            <span class="material-advantage" id="material-bottom"></span>
          </div>
          <div class="timer-group">
            <span class="move-clock" id="move-clock-bottom">0s</span>
            <span class="timer" id="timer-bottom">--:--</span>
          </div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="opening" data-drag-label="Opening">
        <!-- Always-visible opening name -->
        <div class="opening-label" id="opening-label"></div>
        </div>

        <div class="drag-group" data-drag-id="eval-graph" data-drag-label="Eval Graph">
        <!-- Eval Graph (shown after analysis) -->
        <div class="eval-graph-container hidden" id="eval-graph-container"></div>
        <div class="time-graph-container hidden" id="time-graph-container"></div>
        </div>

        <div class="drag-group" data-drag-id="clock" data-drag-label="Clock">
        <!-- Chess Clock -->
        <div class="clock-window" id="clock-window">
          <div class="cw-display cw-display-left" id="cw-left">
            <span class="cw-label" id="cw-label-left">White</span>
            <span class="cw-time" id="cw-time-left">--:--</span>
            <span class="cw-move-time" id="cw-move-left"></span>
          </div>
          <div class="cw-divider"></div>
          <div class="cw-display cw-display-right" id="cw-right">
            <span class="cw-label" id="cw-label-right">Black</span>
            <span class="cw-time" id="cw-time-right">--:--</span>
            <span class="cw-move-time" id="cw-move-right"></span>
          </div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="music" data-drag-label="Music">
        <!-- Mini Music Player -->
        <div class="mini-music" id="mini-music">
          <div class="mini-music-compact">
            <button class="mini-music-btn" id="mini-music-prev" title="Previous">&#9664;&#9664;</button>
            <button class="mini-music-btn mini-music-play" id="mini-music-toggle" title="Play/Pause">&#9654;</button>
            <button class="mini-music-btn" id="mini-music-next" title="Next">&#9654;&#9654;</button>
            <div class="mini-music-info">
              <span class="mini-music-title" id="mini-music-title">-</span>
              <span class="mini-music-composer" id="mini-music-composer">-</span>
            </div>
            <button class="mini-music-btn mini-music-shuffle-btn" id="mini-music-shuffle" title="Shuffle">&#8645;</button>
            <button class="mini-music-btn mini-music-composers-btn" id="mini-music-composers" title="Browse composers">&#9835;</button>
            <input type="range" class="mini-music-vol" id="mini-music-vol" min="0" max="100" value="30" title="Volume">
          </div>
          <!-- Expanded content (visible when resized taller) -->
          <div class="mini-music-expanded" id="mini-music-expanded">
            <div class="mini-music-progress-row">
              <span class="mini-music-time" id="mini-music-time-cur">0:00</span>
              <input type="range" class="mini-music-seek" id="mini-music-seek" min="0" max="1000" value="0" title="Seek">
              <span class="mini-music-time" id="mini-music-time-dur">0:00</span>
            </div>
            <div class="mini-music-detail">
              <img class="mini-music-portrait" id="mini-music-portrait" src="" alt="">
              <div class="mini-music-tracklist" id="mini-music-tracklist"></div>
            </div>
          </div>
        </div>
        <div class="resize-handle resize-handle-h" id="resize-handle-music" title="Drag to resize music player"></div>
        </div>

        <div class="drag-group" data-drag-id="nav" data-drag-label="Arrows">
        <!-- Navigation Controls (under board) -->
        <div class="nav-controls">
          <button class="btn btn-sm" id="btn-flip-shortcut" title="Flip board">&#8693;</button>
          <button class="btn btn-sm" id="btn-first" title="First move">&laquo;</button>
          <button class="btn btn-sm" id="btn-prev" title="Previous move">&lsaquo;</button>
          <button class="btn btn-sm" id="btn-next" title="Next move">&rsaquo;</button>
          <button class="btn btn-sm" id="btn-last" title="Last move">&raquo;</button>
        </div>
        </div>


      </div>

      <!-- Resize Handle -->
      <div class="resize-handle resize-handle-v" id="resize-handle-main" title="Drag to resize"></div>

      <!-- Right: Side Panel -->
      <div class="side-panel">
        <div class="drag-group" data-drag-id="status" data-drag-label="Status">
        <!-- Game Status -->
        <div class="status-bar" id="status-bar">
          <span id="game-status">White to move</span>
          <span id="engine-status" class="hidden">Stockfish: Ready</span>
          <span id="dgt-board-status" class="dgt-board-status hidden">DGT: Connected</span>
          <span id="cu-board-status" class="dgt-board-status hidden">ChessUp: Connected</span>
          <button class="btn btn-sm btn-force hidden" id="btn-force-move">Force Move</button>
          <div class="analyze-group hidden" id="analyze-group">
            <button class="btn btn-sm btn-primary" id="btn-analyze">Analyze</button>
            <select class="analyze-depth-select" id="analyze-depth" title="Analysis depth">
              <option value="10">Quick (~3s/move)</option>
              <option value="16" selected>Normal (~6s/move)</option>
              <option value="22">Deep (~15s/move)</option>
            </select>
          </div>
          <button class="btn btn-sm hidden" id="btn-takeback" title="Request takeback">↩ Take Back</button>
          <button class="btn btn-sm hidden" id="btn-rematch" title="Rematch">⟳ Rematch</button>
          <button class="btn btn-sm hidden" id="btn-resign-mp">Resign</button>
          <button class="btn btn-sm hidden" id="btn-draw-mp">Offer Draw</button>
          <span class="mp-opponent-status hidden" id="mp-opponent-status"></span>
          <div class="analysis-progress hidden" id="analysis-progress">
            <div class="progress-bar"><div class="progress-fill" id="analysis-progress-fill"></div></div>
            <span class="progress-text" id="analysis-progress-text">Analyzing...</span>
          </div>
        </div>
        </div>

        <!-- Analysis Summary (shown after analysis) — not draggable, stays at top -->
        <div class="analysis-summary hidden" id="analysis-summary"></div>

        <div class="drag-group" data-drag-id="tab-bar" data-drag-label="Tab Bar">
        <!-- Move navigation buttons -->
        <div class="moves-nav-bar">
          <button class="btn btn-sm" id="btn-first2" title="First move">&laquo;</button>
          <button class="btn btn-sm" id="btn-prev2" title="Previous move">&lsaquo;</button>
          <button class="btn btn-sm" id="btn-next2" title="Next move">&rsaquo;</button>
          <button class="btn btn-sm" id="btn-last2" title="Last move">&raquo;</button>
          <button class="btn btn-sm" id="btn-flip2" title="Flip board">&#8693;</button>
        </div>
        </div>

        <div class="drag-group" data-drag-id="moves" data-drag-label="Moves">
        <!-- Moves Tab -->
        <div class="panel-content" id="tab-moves">
          <!-- Match Info Header -->
          <div class="match-info-header" id="match-info-header">
            <span class="match-info-label" id="match-info-label"></span>
            <span class="match-info-opening" id="match-info-opening"></span>
          </div>
          <!-- Opening Training Bar -->
          <div class="opening-training-bar hidden" id="opening-training-bar">
            <div class="ot-title" id="ot-title"></div>
            <div class="ot-actions">
              <button class="btn btn-sm ot-btn ot-btn-primary" id="ot-practice">Practice Moves</button>
              <button class="btn btn-sm ot-btn ot-btn-primary" id="ot-quiz">Quiz</button>
              <button class="btn btn-sm ot-btn ot-btn-accent" id="ot-play">Play vs GM</button>
              <button class="btn btn-sm ot-btn" id="ot-continue">Free Play</button>
              <button class="btn btn-sm ot-btn ot-btn-exit" id="ot-exit">Exit</button>
            </div>
          </div>
          <!-- Move History -->
          <div class="move-history-container">
            <div id="move-history" class="move-history"></div>
          </div>
          <div class="resize-handle resize-handle-h" id="resize-handle-moves" title="Drag to resize move list"></div>

          <!-- GM Coach Commentary for Opening Training (below moves) -->
          <div class="ot-coach hidden" id="ot-coach"></div>
          <!-- DB Stats for Opening Training (below coach) -->
          <div class="ot-stats" id="ot-stats"></div>

          <!-- Move Insight (shown after analysis, per-move learning feedback) -->
          <div class="move-insight hidden" id="move-insight"></div>

        </div>
        </div>

        <div class="drag-group" data-drag-id="book" data-drag-label="Book">
        <!-- Book Tab (Opening Explorer) -->
        <div class="panel-content" id="tab-book">
          <div class="book-panel" id="book-panel">
            <div class="book-header">
              <div class="oe-gm-row" id="oe-gm-row"></div>
              <button class="btn btn-xs oe-repertoire-toggle" id="oe-repertoire-toggle" title="Show only your repertoire moves">My Repertoire</button>
            </div>
            <div class="oe-moves-table" id="oe-moves-table"></div>
            <div class="oe-repertoire-summary hidden" id="oe-repertoire-summary"></div>
          </div>
          <div class="resize-handle resize-handle-h" id="resize-handle-book" title="Drag to resize book"></div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="hints" data-drag-label="GM Hints">
        <!-- GM Hints -->
        <div class="panel-content" id="tab-ideas">
          <div class="ideas-panel" id="ideas-panel">
            <div class="advisor-picker" id="advisor-picker"></div>
            <div class="ideas-list" id="ideas-list">
              <div class="ideas-empty">Pick grandmasters or engines to see their ideas for each position.</div>
            </div>
            <div class="advisor-annotations" id="advisor-annotations"></div>
            <div class="ideas-coach-area" id="ideas-coach-area"></div>
          </div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="gm-coach-tab" data-drag-label="GM Coach">
        <!-- GM Coach -->
        <div class="panel-content" id="tab-gm-coach">
          <div class="gm-coach-panel" id="gm-coach-panel">
            <div class="gm-coach-header">
              <span class="split-pane-label" style="padding:0">Coach</span>
              <button class="btn btn-sm" id="btn-coach-settings" title="Settings">&#x2699;</button>
            </div>
            <div class="gm-coach-picker" id="gm-coach-picker"></div>
            <div class="gm-coach-cards" id="gm-coach-cards">
              <div class="gm-coach-empty">Pick a grandmaster or engine to receive personalized coaching.</div>
            </div>
            <div class="gm-coach-chat">
              <div class="gm-coach-chat-messages" id="gm-coach-chat-messages"></div>
              <div class="gm-coach-chat-input">
                <input type="text" id="gm-coach-input" placeholder="Ask your coaches...">
                <button class="btn btn-sm btn-primary" id="btn-gm-coach-send">Send</button>
              </div>
            </div>
            <div class="gm-coach-status" id="gm-coach-status"></div>
          </div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="engine-lines" data-drag-label="Engine Lines">
        <!-- Multi-PV Engine Lines (v147) -->
        <div class="panel-content hidden" id="tab-engine-lines">
          <div class="multi-pv-panel" id="multi-pv-panel">
            <div class="multi-pv-header">
              <span class="split-pane-label" style="padding:0">Engine Lines</span>
              <label class="layout-toggle-row" style="margin:0"><span class="toggle-switch" style="margin-left:8px"><input type="checkbox" id="toggle-multi-pv"><span class="toggle-slider"></span></span></label>
            </div>
            <div class="multi-pv-lines" id="multi-pv-lines"></div>
          </div>
        </div>
        </div>

        <div class="drag-group" data-drag-id="coach-area" data-drag-label="Coach">
        <!-- GM Coach Commentary (always visible, outside tabs) -->
        <div class="panel-coach-area hidden" id="panel-coach-area"></div>
        </div>

        <div class="drag-group" data-drag-id="move-note" data-drag-label="Move Notes">
        <div class="move-notes" id="move-notes">
          <div class="move-notes-label" id="move-notes-label">Move</div>
          <textarea class="move-notes-input" id="move-notes-input" placeholder="Add note for this move..."></textarea>
        </div>
        </div>

        <div class="drag-group" data-drag-id="match-note" data-drag-label="Match Notes">
        <div class="match-notes" id="match-notes">
          <div class="move-notes-label" id="match-notes-label">Match</div>
          <textarea class="move-notes-input" id="match-notes-input" placeholder="Add note for this match..."></textarea>
          <button class="notes-save-btn" id="btn-save-game" title="Save game to My Games">Save</button>
        </div>
        <div class="resize-handle resize-handle-h" id="resize-handle-notes" title="Drag to resize notes"></div>
        </div>

      </div>
    </main>

    <!-- History Dialog (Feature 13) -->
    <div id="history-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Game History</h2>
        <div class="history-filters">
          <input type="text" id="history-search" class="history-search" placeholder="Search opponent or opening...">
          <select id="history-filter-result" class="history-filter-select">
            <option value="all">All Results</option>
            <option value="win">Wins</option>
            <option value="loss">Losses</option>
            <option value="draw">Draws</option>
          </select>
        </div>
        <div class="history-list" id="history-list"></div>
        <div class="dialog-actions">
          <button class="btn btn-primary" id="history-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Game Result Banner (Feature 12) -->
    <div id="game-result-banner" class="game-result-banner hidden">
      <div class="result-banner-content">
        <div class="result-banner-text" id="result-banner-text">Game Over</div>
        <div class="result-banner-accuracy" id="result-banner-accuracy"></div>
        <div class="result-banner-actions">
          <button class="btn btn-primary" id="result-btn-review">Review Game</button>
          <button class="btn btn-accent" id="result-btn-rematch">Rematch</button>
          <button class="btn btn-secondary" id="result-btn-new">New Game</button>
        </div>
      </div>
    </div>

    <!-- Blunder Alert (Feature 11) -->
    <div id="blunder-alert" class="blunder-alert hidden">
      <span class="blunder-alert-icon" id="blunder-alert-icon"></span>
      <span class="blunder-alert-text" id="blunder-alert-text"></span>
      <a class="blunder-alert-takeback" id="blunder-alert-takeback">Take back?</a>
      <button class="blunder-alert-dismiss" id="blunder-alert-dismiss">&times;</button>
    </div>

    <!-- Countdown Overlay (Feature 6) -->
    <div id="countdown-overlay" class="countdown-overlay hidden">
      <div class="countdown-number" id="countdown-number">3</div>
    </div>

    <!-- Takeback Button (Feature 5) — in status bar area -->

    <!-- Repertoire Dialog (v146) -->
    <div id="repertoire-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Opening Repertoire</h2>
        <div class="rep-tabs">
          <button class="rep-tab active" data-rep-tab="lines">My Lines</button>
          <button class="rep-tab" data-rep-tab="drill">Drill</button>
          <button class="rep-tab" data-rep-tab="stats">Stats</button>
        </div>
        <div class="rep-tab-content" id="rep-tab-lines">
          <div class="rep-actions">
            <button class="btn btn-sm btn-accent" id="btn-rep-add-mainline">Add from Openings</button>
            <button class="btn btn-sm" id="btn-rep-add-current">Add Current Game</button>
          </div>
          <div class="repertoire-list" id="repertoire-list"></div>
        </div>
        <div class="rep-tab-content hidden" id="rep-tab-drill">
          <div class="rep-drill-summary" id="rep-drill-summary"></div>
          <div class="rep-drill-due" id="rep-drill-due"></div>
        </div>
        <div class="rep-tab-content hidden" id="rep-tab-stats">
          <div class="rep-stats-overview" id="rep-stats-overview"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-primary" id="repertoire-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Repertoire ECO Picker Dialog -->
    <div id="rep-eco-picker" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Add Opening Line</h2>
        <div class="rep-eco-list" id="rep-eco-list"></div>
        <div class="rep-color-pick">
          <label>Play as: </label>
          <select id="rep-eco-color"><option value="w">White</option><option value="b">Black</option></select>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="rep-eco-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Multi-PV Lines Panel Content (v147) — inside side panel -->

    <!-- Lichess Import Dialog (v150) -->
    <div id="lichess-import-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Lichess Game Import</h2>
        <div class="lichess-import-form">
          <input type="text" class="lichess-username-input" id="lichess-username" placeholder="Lichess username...">
          <button class="btn btn-primary" id="btn-lichess-fetch">Fetch Games</button>
        </div>
        <div class="lichess-game-controls hidden" id="lichess-game-controls">
          <label><input type="checkbox" id="lichess-select-all"> Select All</label>
          <button class="btn btn-sm btn-accent" id="btn-lichess-import-selected">Import Selected</button>
        </div>
        <div class="lichess-game-list" id="lichess-game-list"></div>
        <div class="lichess-import-status" id="lichess-import-status"></div>
        <div class="dialog-actions">
          <button class="btn btn-primary" id="lichess-import-close">Close</button>
        </div>
      </div>
    </div>

    <!-- GIF Export Dialog (v151) -->
    <div id="gif-export-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Export Animated GIF</h2>
        <div class="gif-settings">
          <div class="gif-setting-row">
            <label>Frame delay:</label>
            <input type="range" id="gif-frame-delay" min="500" max="2000" value="1000" step="100">
            <span id="gif-delay-label">1000ms</span>
          </div>
          <div class="gif-setting-row">
            <label>Board size:</label>
            <select id="gif-board-size">
              <option value="400">400px</option>
              <option value="600" selected>600px</option>
            </select>
          </div>
          <div class="gif-setting-row">
            <span id="gif-move-count"></span>
          </div>
        </div>
        <div class="gif-progress hidden" id="gif-progress">
          <div class="gif-progress-bar"><div class="gif-progress-fill" id="gif-progress-fill"></div></div>
          <span id="gif-progress-text">Preparing...</span>
        </div>
        <div class="gif-preview hidden" id="gif-preview"><img id="gif-preview-img" alt="GIF preview"></div>
        <div class="dialog-actions">
          <button class="btn btn-accent" id="btn-gif-export">Export GIF</button>
          <button class="btn btn-secondary" id="gif-export-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Saved Games Dialog (v152) -->
    <div id="saved-games-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Saved Games</h2>
        <div class="saved-games-header">
          <label class="layout-toggle-row"><span class="layout-toggle-label">Auto-save</span><span class="toggle-switch"><input type="checkbox" id="toggle-auto-save"><span class="toggle-slider"></span></span></label>
          <span class="saved-games-count" id="saved-games-count"></span>
        </div>
        <div class="saved-games-list" id="saved-games-list"></div>
        <div class="dialog-actions">
          <button class="btn btn-primary" id="saved-games-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Annotation Popup (v149) -->
    <div id="annotation-popup" class="annotation-popup hidden">
      <div class="ann-nag-row">
        <button class="ann-nag-btn" data-nag="!">!</button>
        <button class="ann-nag-btn" data-nag="?">?</button>
        <button class="ann-nag-btn" data-nag="!!">!!</button>
        <button class="ann-nag-btn" data-nag="??">??</button>
        <button class="ann-nag-btn" data-nag="!?">!?</button>
        <button class="ann-nag-btn" data-nag="?!">?!</button>
      </div>
      <textarea id="ann-comment" class="ann-comment" placeholder="Add comment..." rows="2"></textarea>
      <div class="ann-actions">
        <button class="btn btn-sm btn-secondary" id="ann-clear">Clear</button>
        <button class="btn btn-sm btn-secondary" id="ann-cancel">Cancel</button>
        <button class="btn btn-sm btn-primary" id="ann-save">Save</button>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="lib/chess.min.js"></script>
  <script type="module" src="js/main.js?v=158"></script>
  <script>
    // PWA install prompt
    var deferredInstallPrompt = null;
    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredInstallPrompt = e;
      // Show install banner after 30s if user hasn't installed
      setTimeout(function() {
        if (!deferredInstallPrompt) return;
        var banner = document.getElementById('pwa-install-banner');
        if (banner) banner.classList.remove('hidden');
      }, 30000);
    });
    window.addEventListener('appinstalled', function() {
      deferredInstallPrompt = null;
      var banner = document.getElementById('pwa-install-banner');
      if (banner) banner.classList.add('hidden');
    });

    if ('serviceWorker' in navigator && !window.Capacitor) {
      navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' })
        .then(function(reg) {
          // Check for updates immediately and every 60s
          reg.update().catch(function() {});
          setInterval(function() { reg.update().catch(function() {}); }, 60000);

          reg.addEventListener('updatefound', function() {
            var newSW = reg.installing;
            if (newSW) {
              newSW.addEventListener('statechange', function() {
                if (newSW.state === 'activated') {
                  window.location.reload();
                }
              });
            }
          });
        })
        .catch(function() {});

      // PWA install button handlers
      var installBtn = document.getElementById('pwa-install-btn');
      var dismissBtn = document.getElementById('pwa-install-dismiss');
      if (installBtn) {
        installBtn.addEventListener('click', function() {
          if (!deferredInstallPrompt) return;
          deferredInstallPrompt.prompt();
          deferredInstallPrompt.userChoice.then(function() {
            deferredInstallPrompt = null;
            var banner = document.getElementById('pwa-install-banner');
            if (banner) banner.classList.add('hidden');
          });
        });
      }
      if (dismissBtn) {
        dismissBtn.addEventListener('click', function() {
          var banner = document.getElementById('pwa-install-banner');
          if (banner) banner.classList.add('hidden');
          deferredInstallPrompt = null;
        });
      }

      // Listen for SW_UPDATED message — reload to get fresh assets
      navigator.serviceWorker.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'SW_UPDATED') {
          window.location.reload();
        }
      });
    }
  </script>
</body>
</html>
