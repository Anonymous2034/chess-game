<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grandmasters</title>
  <link rel="stylesheet" href="css/style.css">
  <script type="importmap">
  {
    "imports": {
      "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
    }
  }
  </script>
</head>
<body>
  <div id="app">
    <!-- New Game Dialog -->
    <div id="new-game-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-new-game">
        <h2>New Game</h2>
        <div class="dialog-section">
          <label>Mode</label>
          <div class="btn-group" data-setting="mode">
            <button class="btn active" data-value="local">Two Player</button>
            <button class="btn" data-value="engine">vs Computer</button>
          </div>
        </div>
        <div class="dialog-section engine-only">
          <label>Choose your opponent</label>
          <div class="bot-picker-layout">
            <div class="bot-picker-list" id="bot-picker-list"></div>
            <div class="bot-picker-detail" id="bot-picker-detail"></div>
          </div>
        </div>
        <div class="dialog-section engine-only">
          <label>Play as</label>
          <div class="btn-group" data-setting="color">
            <button class="btn active" data-value="w">White</button>
            <button class="btn" data-value="b">Black</button>
            <button class="btn" data-value="random">Random</button>
          </div>
        </div>
        <div class="dialog-section">
          <label>Time Control</label>
          <div class="time-control-grid" id="time-control-grid">
            <div class="tc-category">
              <span class="tc-label">None</span>
              <div class="tc-buttons">
                <button class="btn btn-sm tc-btn active" data-time="0" data-increment="0">No Timer</button>
              </div>
            </div>
            <div class="tc-category">
              <span class="tc-label">Bullet</span>
              <div class="tc-buttons">
                <button class="btn btn-sm tc-btn" data-time="60" data-increment="0">1 min</button>
                <button class="btn btn-sm tc-btn" data-time="60" data-increment="1">1+1</button>
                <button class="btn btn-sm tc-btn" data-time="120" data-increment="1">2+1</button>
              </div>
            </div>
            <div class="tc-category">
              <span class="tc-label">Blitz</span>
              <div class="tc-buttons">
                <button class="btn btn-sm tc-btn" data-time="180" data-increment="0">3 min</button>
                <button class="btn btn-sm tc-btn" data-time="180" data-increment="2">3+2</button>
                <button class="btn btn-sm tc-btn" data-time="300" data-increment="0">5 min</button>
                <button class="btn btn-sm tc-btn" data-time="300" data-increment="3">5+3</button>
              </div>
            </div>
            <div class="tc-category">
              <span class="tc-label">Rapid</span>
              <div class="tc-buttons">
                <button class="btn btn-sm tc-btn" data-time="600" data-increment="0">10 min</button>
                <button class="btn btn-sm tc-btn" data-time="900" data-increment="10">15+10</button>
                <button class="btn btn-sm tc-btn" data-time="1800" data-increment="0">30 min</button>
              </div>
            </div>
            <div class="tc-category">
              <span class="tc-label">Classical</span>
              <div class="tc-buttons">
                <button class="btn btn-sm tc-btn" data-time="3600" data-increment="0">60 min</button>
              </div>
            </div>
            <div class="tc-category">
              <span class="tc-label">Custom</span>
              <div class="tc-buttons tc-custom">
                <button class="btn btn-sm tc-btn" data-time="custom" data-increment="0">Custom</button>
                <div class="tc-custom-inputs hidden" id="tc-custom-inputs">
                  <input type="number" id="tc-custom-minutes" min="1" max="180" value="10" placeholder="min"> min
                  <input type="number" id="tc-custom-increment" min="0" max="60" value="0" placeholder="inc"> sec
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-new-game">Cancel</button>
          <button class="btn btn-primary" id="start-new-game">Start Game</button>
        </div>
      </div>
    </div>

    <!-- Promotion Dialog -->
    <div id="promotion-dialog" class="dialog-overlay hidden">
      <div class="dialog promotion-dialog">
        <h3>Promote pawn to:</h3>
        <div class="promotion-pieces">
          <button class="promotion-piece" data-piece="q"><img alt="Queen"></button>
          <button class="promotion-piece" data-piece="r"><img alt="Rook"></button>
          <button class="promotion-piece" data-piece="b"><img alt="Bishop"></button>
          <button class="promotion-piece" data-piece="n"><img alt="Knight"></button>
        </div>
      </div>
    </div>

    <!-- PGN Import Dialog -->
    <div id="pgn-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Import PGN</h2>
        <textarea id="pgn-input" placeholder="Paste PGN here..." rows="10"></textarea>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-pgn">Cancel</button>
          <button class="btn btn-primary" id="load-pgn">Load</button>
        </div>
      </div>
    </div>

    <!-- Database Browser Dialog -->
    <div id="database-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Game Database</h2>
        <div class="db-category-tabs" id="db-category-tabs">
          <button class="db-tab active" data-category="all">All</button>
        </div>
        <div class="db-controls">
          <input type="text" id="db-search" placeholder="Search by player, event, ECO...">
          <select id="db-collection">
            <option value="all">All Collections</option>
          </select>
        </div>
        <div id="db-games-list" class="db-games-list"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-database">Close</button>
        </div>
      </div>
    </div>

    <!-- Stats Dialog -->
    <div id="stats-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Player Statistics</h2>
        <div id="stats-content" class="stats-content"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-stats">Close</button>
        </div>
      </div>
    </div>

    <!-- Tournament Setup Dialog -->
    <div id="tournament-setup-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>New Tournament</h2>
        <div class="dialog-section">
          <label>Format</label>
          <div class="btn-group" id="tournament-format-group">
            <button class="btn active" data-value="round-robin">Round Robin</button>
            <button class="btn" data-value="knockout">Knockout</button>
          </div>
        </div>
        <div class="dialog-section">
          <label>Select Opponents</label>
          <div class="tournament-opponents" id="tournament-opponents"></div>
        </div>
        <div class="dialog-section">
          <label>Games per Match</label>
          <div class="btn-group" id="tournament-games-group">
            <button class="btn active" data-value="1">1</button>
            <button class="btn" data-value="2">2</button>
            <button class="btn" data-value="4">4</button>
          </div>
        </div>
        <div class="dialog-section">
          <label>Time Control</label>
          <div class="btn-group" id="tournament-time-group">
            <button class="btn active" data-time="0" data-increment="0">No Timer</button>
            <button class="btn" data-time="180" data-increment="2">3+2</button>
            <button class="btn" data-time="300" data-increment="3">5+3</button>
            <button class="btn" data-time="600" data-increment="0">10 min</button>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-tournament-setup">Cancel</button>
          <button class="btn btn-primary" id="start-tournament">Start Tournament</button>
        </div>
      </div>
    </div>

    <!-- Tournament Progress Dialog -->
    <div id="tournament-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2 id="tournament-title">Tournament</h2>
        <div id="tournament-content" class="tournament-content"></div>
        <div class="dialog-actions">
          <button class="btn btn-sm hidden" id="tournament-next-match">Play Next Match</button>
          <button class="btn btn-secondary" id="tournament-close">Close</button>
          <button class="btn btn-secondary" id="tournament-abandon">Abandon</button>
        </div>
      </div>
    </div>

    <!-- Admin Dialog -->
    <div id="admin-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Admin Panel</h2>
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="users">Users</button>
          <button class="admin-tab" data-tab="leaderboard">Leaderboard</button>
        </div>
        <div id="admin-content" class="admin-content"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-admin">Close</button>
        </div>
      </div>
    </div>

    <!-- Auth Dialog -->
    <div id="auth-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <!-- Login Form -->
        <div id="login-form">
          <h2>Login</h2>
          <div class="dialog-section">
            <label>Email</label>
            <input type="email" id="login-email" placeholder="your@email.com">
          </div>
          <div class="dialog-section">
            <label>Password</label>
            <input type="password" id="login-password" placeholder="Password">
          </div>
          <div class="auth-error hidden" id="login-error"></div>
          <div class="dialog-actions">
            <button class="btn btn-secondary" id="close-auth">Close</button>
            <button class="btn btn-primary" id="btn-login">Login</button>
          </div>
          <div class="auth-switch">
            Don't have an account? <a href="#" id="show-register">Register</a>
          </div>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="hidden">
          <h2>Register</h2>
          <div class="dialog-section">
            <label>Display Name</label>
            <input type="text" id="register-name" placeholder="Your name">
          </div>
          <div class="dialog-section">
            <label>Email</label>
            <input type="email" id="register-email" placeholder="your@email.com">
          </div>
          <div class="dialog-section">
            <label>Password</label>
            <input type="password" id="register-password" placeholder="Password (6+ chars)">
          </div>
          <div class="auth-error hidden" id="register-error"></div>
          <div class="dialog-actions">
            <button class="btn btn-secondary" id="back-to-login">Back</button>
            <button class="btn btn-primary" id="btn-register">Register</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot Match Dialog -->
    <div id="bot-match-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-new-game">
        <h2>Bot vs Bot Match</h2>
        <div class="dialog-section">
          <label>White</label>
          <div class="bot-match-picker" id="bot-match-white"></div>
        </div>
        <div class="dialog-section">
          <label>Black</label>
          <div class="bot-match-picker" id="bot-match-black"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="cancel-bot-match">Cancel</button>
          <button class="btn btn-primary" id="start-bot-match">Simulate</button>
        </div>
      </div>
    </div>

    <!-- Bot Match Progress Dialog -->
    <div id="bot-match-progress" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Simulating Game...</h2>
        <div class="bot-match-status" id="bot-match-status">Preparing...</div>
        <div class="progress-bar"><div class="progress-fill" id="bot-match-progress-fill"></div></div>
      </div>
    </div>

    <!-- Theme Settings Dialog -->
    <div id="theme-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Themes</h2>
        <div class="theme-section">
          <h4>Board</h4>
          <div class="board-theme-swatches" id="board-theme-swatches"></div>
        </div>
        <div class="theme-section">
          <h4>Pieces</h4>
          <div class="piece-theme-list" id="piece-theme-list"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-theme-dialog">Close</button>
        </div>
      </div>
    </div>

    <!-- Multi-Bot Analysis Dialog -->
    <div id="multi-analysis-dialog" class="dialog-overlay hidden">
      <div class="dialog dialog-wide">
        <h2>Analysis Lines</h2>
        <p class="multi-analysis-desc">See how different grandmasters and bots would play this position.</p>
        <div class="multi-analysis-bots" id="multi-analysis-bots"></div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-multi-analysis">Close</button>
          <button class="btn btn-primary" id="run-multi-analysis">Analyze Position</button>
        </div>
        <div class="multi-analysis-results hidden" id="multi-analysis-results"></div>
      </div>
    </div>

    <!-- Coach Settings Dialog -->
    <div id="coach-settings-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>Coach Settings</h2>
        <div class="dialog-section">
          <label>Coaching Tier</label>
          <div class="btn-group" id="coach-tier-group">
            <button class="btn active" data-value="1">Stockfish Tips</button>
            <button class="btn" data-value="2">In-Browser AI</button>
            <button class="btn" data-value="3">API Key</button>
          </div>
        </div>
        <div class="dialog-section hidden" id="coach-webllm-section">
          <label>In-Browser AI (WebLLM)</label>
          <p class="coach-info" id="coach-webllm-info">Runs a small AI model directly in your browser. Free, no API key needed. Requires WebGPU (Chrome 113+).</p>
          <button class="btn btn-sm" id="coach-load-webllm">Load Model</button>
          <div class="coach-progress hidden" id="coach-webllm-progress">
            <div class="progress-bar"><div class="progress-fill" id="coach-webllm-progress-fill"></div></div>
            <span class="progress-text" id="coach-webllm-progress-text"></span>
          </div>
        </div>
        <div class="dialog-section hidden" id="coach-api-section">
          <label>API Configuration</label>
          <div class="coach-api-form">
            <div class="form-row">
              <label>Provider</label>
              <select id="coach-api-provider">
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic (Claude)</option>
              </select>
            </div>
            <div class="form-row">
              <label>API Key</label>
              <input type="password" id="coach-api-key" placeholder="Enter your API key">
            </div>
            <div class="form-row">
              <label>Model (optional)</label>
              <input type="text" id="coach-api-model" placeholder="e.g., gpt-4o-mini">
            </div>
            <button class="btn btn-sm btn-primary" id="coach-api-save">Save</button>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" id="close-coach-settings">Close</button>
        </div>
      </div>
    </div>

    <!-- DGT Board Dialog -->
    <div id="dgt-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h2>DGT Board</h2>
        <div class="dgt-status-indicator" id="dgt-status-indicator">
          <span class="dgt-status-dot" id="dgt-status-dot"></span>
          <span id="dgt-status-text">Not connected</span>
        </div>
        <div class="dgt-connect-options" id="dgt-connect-options">
          <button class="dgt-connect-btn" id="dgt-connect-usb">
            <div class="dgt-connect-title">USB (Web Serial)</div>
            <div class="dgt-connect-desc">Direct USB connection. Chrome/Edge only.</div>
          </button>
          <button class="dgt-connect-btn" id="dgt-connect-livechess">
            <div class="dgt-connect-title">DGT LiveChess</div>
            <div class="dgt-connect-desc">Connect via LiveChess 2 software (WebSocket).</div>
          </button>
        </div>
        <div class="dgt-engine-move hidden" id="dgt-engine-move">
          <div class="dgt-engine-move-label">Play this move on your board:</div>
          <div class="dgt-engine-move-san" id="dgt-engine-move-san"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary hidden" id="dgt-disconnect">Disconnect</button>
          <button class="btn btn-secondary" id="close-dgt">Close</button>
        </div>
      </div>
    </div>

    <!-- Move Analysis Tooltip -->
    <div id="move-tooltip" class="move-tooltip hidden"></div>

    <!-- Header -->
    <header>
      <h1>Grandmasters</h1>
      <nav>
        <button class="btn" id="btn-new-game">New Game</button>
        <button class="btn" id="btn-flip">Flip Board</button>
        <button class="btn" id="btn-database">Database</button>
        <button class="btn" id="btn-stats">Stats</button>
        <button class="btn" id="btn-tournament">Tournament</button>
        <button class="btn" id="btn-bot-match">Bot Match</button>
        <button class="btn" id="btn-themes">Themes</button>
        <button class="btn" id="btn-multi-analysis">Analysis Lines</button>
        <button class="btn" id="btn-dgt">DGT Board</button>
        <div class="dropdown">
          <button class="btn" id="btn-pgn-menu">PGN</button>
          <div class="dropdown-content">
            <button id="btn-import-pgn">Import PGN</button>
            <button id="btn-export-pgn">Export PGN</button>
          </div>
        </div>
        <button class="btn hidden" id="btn-admin">Admin</button>
        <span class="nav-separator"></span>
        <span class="auth-status hidden" id="auth-status"></span>
        <button class="btn" id="btn-auth">Login</button>
      </nav>
    </header>

    <!-- Main Content -->
    <main>
      <!-- Left: Board Area -->
      <div class="board-area">
        <!-- Top Player Info -->
        <div class="player-info top" id="player-top">
          <div class="player-info-left">
            <span class="player-name">Black</span>
            <span class="captured-pieces" id="captured-top"></span>
            <span class="material-advantage" id="material-top"></span>
          </div>
          <span class="timer" id="timer-top">--:--</span>
        </div>

        <!-- Chess Board -->
        <div id="board-container">
          <div id="board" class="board"></div>
          <!-- Coordinate labels -->
          <div class="coords coords-files" id="coords-files"></div>
          <div class="coords coords-ranks" id="coords-ranks"></div>
        </div>

        <!-- Bottom Player Info -->
        <div class="player-info bottom" id="player-bottom">
          <div class="player-info-left">
            <span class="player-name">White</span>
            <span class="captured-pieces" id="captured-bottom"></span>
            <span class="material-advantage" id="material-bottom"></span>
          </div>
          <span class="timer" id="timer-bottom">--:--</span>
        </div>

        <!-- Always-visible opening name -->
        <div class="opening-label" id="opening-label"></div>

        <!-- Eval Graph (shown after analysis) -->
        <div class="eval-graph-container hidden" id="eval-graph-container"></div>

        <!-- Navigation Controls (under board) -->
        <div class="nav-controls">
          <button class="btn btn-sm" id="btn-first" title="First move">&laquo;</button>
          <button class="btn btn-sm" id="btn-prev" title="Previous move">&lsaquo;</button>
          <button class="btn btn-sm" id="btn-next" title="Next move">&rsaquo;</button>
          <button class="btn btn-sm" id="btn-last" title="Last move">&raquo;</button>
        </div>
      </div>

      <!-- Right: Side Panel -->
      <div class="side-panel">
        <!-- Game Status -->
        <div class="status-bar" id="status-bar">
          <span id="game-status">White to move</span>
          <span id="engine-status" class="hidden">Stockfish: Ready</span>
          <span id="dgt-board-status" class="dgt-board-status hidden">DGT: Connected</span>
          <button class="btn btn-sm btn-force hidden" id="btn-force-move">Force Move</button>
          <button class="btn btn-sm btn-primary hidden" id="btn-analyze">Analyze Game</button>
          <div class="analysis-progress hidden" id="analysis-progress">
            <div class="progress-bar"><div class="progress-fill" id="analysis-progress-fill"></div></div>
            <span class="progress-text" id="analysis-progress-text">Analyzing...</span>
          </div>
        </div>

        <!-- Analysis Summary (shown after analysis) -->
        <div class="analysis-summary hidden" id="analysis-summary"></div>

        <!-- Side Panel Tabs -->
        <div class="panel-tabs">
          <button class="panel-tab active" data-tab="moves">Moves</button>
          <button class="panel-tab" data-tab="coach">Coach</button>
        </div>

        <!-- Moves Tab -->
        <div class="panel-content" id="tab-moves">
          <!-- Move History -->
          <div class="move-history-container">
            <div id="move-history" class="move-history"></div>
          </div>

          <!-- Game Controls -->
          <div class="game-controls">
            <button class="btn btn-sm" id="btn-undo" title="Undo">Undo</button>
            <button class="btn btn-sm" id="btn-redo" title="Redo">Redo</button>
          </div>

          <!-- Opening Explorer -->
          <div class="opening-explorer">
            <h3>Opening Explorer</h3>
            <div id="opening-name" class="opening-name"></div>
            <div id="explorer-moves" class="explorer-moves"></div>
          </div>
        </div>

        <!-- Coach Tab -->
        <div class="panel-content hidden" id="tab-coach">
          <div class="coach-panel">
            <div class="coach-header">
              <span class="coach-tier-badge" id="coach-tier-badge">Tier 1</span>
              <button class="btn btn-sm" id="btn-coach-settings" title="Coach Settings">Settings</button>
            </div>
            <div class="coach-messages" id="coach-messages"></div>
            <div class="coach-input">
              <input type="text" id="coach-input" placeholder="Ask your coach...">
              <button class="btn btn-sm btn-primary" id="btn-coach-send">Send</button>
            </div>
            <div class="coach-status" id="coach-status"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="lib/chess.min.js"></script>
  <script type="module" src="js/main.js"></script>
</body>
</html>
